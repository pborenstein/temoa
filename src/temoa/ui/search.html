<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Temoa</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Temoa">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #1a1a1a;
            padding: 16px;
            line-height: 1.5;
            color: #e0e0e0;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 16px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 4px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: #ffffff;
            flex-shrink: 1;
        }

        .subtitle {
            color: #888888;
            font-size: 13px;
        }

        .nav-link {
            color: #888888;
            text-decoration: none;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-link:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .vault-selector {
            margin-bottom: 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .vault-selector-label {
            color: #888888;
            font-size: 12px;
        }

        .vault-select {
            display: inline-block;
            width: auto;
            min-width: 150px;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .vault-select:focus {
            border-color: #666666;
        }

        .vault-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .vault-info {
            font-size: 12px;
            color: #888888;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .vault-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            background: #2a2a2a;
            border: 1px solid #404040;
            font-size: 11px;
            color: #888888;
        }

        .vault-badge.default {
            background: #1a3a1a;
            border-color: #2a5a2a;
            color: #6a6;
        }

        .vault-badge.indexed {
            background: #1a1a3a;
            border-color: #2a2a5a;
            color: #66a;
        }

        .search-box {
            position: relative;
            margin-bottom: 12px;
        }

        #query {
            width: 100%;
            padding: 14px 16px;
            padding-right: 60px;
            font-size: 16px;
            border: 1px solid #404040;
            border-radius: 8px;
            background: #2a2a2a;
            color: #e0e0e0;
            transition: border-color 0.2s;
            outline: none;
        }

        #query:focus {
            border-color: #666666;
        }

        #query::placeholder {
            color: #666666;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-label {
            font-size: 12px;
            color: #888888;
            margin-bottom: 6px;
            font-weight: 500;
        }

        input[type="number"], input[type="text"] {
            padding: 8px 10px;
            font-size: 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #1a1a1a;
            color: #e0e0e0;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus, input[type="text"]:focus {
            border-color: #666666;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .info-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            line-height: 14px;
            text-align: center;
            border-radius: 50%;
            background: #404040;
            color: #888888;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            flex-shrink: 0;
        }

        .info-icon:hover {
            background: #505050;
            color: #b0b0b0;
        }

        .tooltip-popup {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #505050;
            border-radius: 8px;
            padding: 12px;
            max-width: 280px;
            font-size: 13px;
            line-height: 1.5;
            color: #e0e0e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .tooltip-popup.active {
            display: block;
        }

        .tooltip-popup .tooltip-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .tooltip-popup .tooltip-section {
            margin-bottom: 6px;
        }

        .tooltip-popup .tooltip-label {
            color: #888888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Type Filter Controls */
        .type-filter-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .type-select {
            flex: 1;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 4px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .type-select:focus {
            border-color: #666666;
        }

        .type-select option {
            padding: 4px;
        }

        .clear-btn {
            padding: 6px 12px;
            font-size: 13px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #404040;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .clear-btn:hover {
            background: #333333;
        }

        .help-text {
            font-size: 12px;
            color: #666666;
            font-style: italic;
            margin-top: 4px;
        }

        /* Collapsible section */
        .collapsible-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            margin-bottom: 12px;
        }

        .collapsible-header:hover {
            background: #323232;
        }

        .collapsible-header .arrow {
            font-size: 14px;
            transition: transform 0.2s;
            color: #888888;
        }

        .collapsible-header.expanded .arrow {
            transform: rotate(90deg);
        }

        .collapsible-header .label {
            flex: 1;
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .collapsible-content {
            display: none;
            background: #2a2a2a;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #404040;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .collapsible-content.expanded {
            display: grid;
        }

        .search-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: auto;
            padding: 8px 14px;
            font-size: 14px;
            font-weight: 600;
            background: #404040;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            margin: 0;
        }

        .search-btn:hover {
            background: #4a4a4a;
        }

        .search-btn:active {
            background: #505050;
        }

        .search-btn:disabled {
            background: #2a2a2a;
            color: #666666;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #888888;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #404040;
            border-top-color: #888888;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #3a2a1a;
            border: 1px solid #5a3a1a;
            color: #ffcc99;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .error.active {
            display: block;
        }

        /* Stats Panel - Compact and Collapsible */
        .stats-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            margin-bottom: 12px;
        }

        .stats-header:hover {
            background: #323232;
        }

        .stats-header .arrow {
            font-size: 12px;
            transition: transform 0.2s;
            color: #888888;
        }

        .stats-header.expanded .arrow {
            transform: rotate(90deg);
        }

        .stats-summary {
            flex: 1;
            font-size: 13px;
            color: #e0e0e0;
        }

        .stats-summary strong {
            font-weight: 600;
        }

        .stats-details {
            display: none;
            background: #2a2a2a;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 6px;
            border: 1px solid #404040;
            font-size: 12px;
            color: #888888;
        }

        .stats-details.expanded {
            display: block;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .stats-row-label {
            color: #888888;
        }

        .stats-row-value {
            color: #e0e0e0;
            font-weight: 500;
        }

        .json-viewer {
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre;
            display: none;
            border: 1px solid #404040;
        }

        .json-viewer.active {
            display: block;
        }

        /* Results Controls */
        .results-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .results-header {
            color: #888888;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .results-buttons {
            display: flex;
            gap: 8px;
        }

        .results-control-btn {
            padding: 6px 12px;
            font-size: 13px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #404040;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .results-control-btn:hover {
            background: #333333;
            border-color: #505050;
        }

        .results-control-btn:active {
            background: #3a3a3a;
        }

        .results-table {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .result-row {
            background: #2a2a2a;
            padding: 12px 20px;  /* Compact padding when collapsed */
            border-radius: 8px;
            border: 1px solid #404040;
            transition: all 0.2s;
            cursor: pointer;  /* Indicate clickable */
        }

        .result-row.expanded {
            padding: 20px;  /* Full padding when expanded */
        }

        .result-row:hover {
            background: #323232;
            border-color: #505050;
        }

        .result-header {
            display: flex;
            flex-direction: column;  /* Stack title and badges vertically when collapsed */
            align-items: flex-start;
            margin-bottom: 0;  /* No margin when collapsed */
            gap: 8px;
            position: relative;
            padding-left: 20px;  /* Space for arrow */
        }

        .result-row.expanded .result-header {
            flex-direction: row;  /* Side-by-side when expanded */
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 12px;  /* Restore margin when expanded */
        }

        /* Collapse/expand arrow */
        .result-header::before {
            content: '▶';
            position: absolute;
            left: 0;
            font-size: 10px;
            color: #888;
            transition: transform 0.2s;
        }

        .result-row.expanded .result-header::before {
            transform: rotate(90deg);
        }

        /* Details section (hidden by default) */
        .result-details {
            /* No display:none needed - conditionally added to DOM */
        }

        .result-title-link {
            font-weight: 600;
            color: #b0b0b0;
            text-decoration: none;
            font-size: 16px;
            flex: 1;
            line-height: 1.4;
        }

        .result-title-link:hover {
            color: #d0d0d0;
            text-decoration: underline;
        }

        .result-badges {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .result-score-badge {
            background: #3a3a3a;
            color: #c0c0c0;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .result-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #666666;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .result-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .result-path {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #777777;
        }

        .result-description {
            color: #b0b0b0;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 12px;
            padding: 14px;
            background: #222222;
            border-radius: 6px;
            border: 1px solid #3a3a3a;
        }

        .result-tags {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            background: #3a3a3a;
            color: #888888;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        .type-badge {
            background: #2a4a2a;
            color: #88cc88;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .project-badge {
            background: #3a3a5a;
            color: #b0b0ff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }

        .project-badge:hover {
            background: #4a4a6a;
            color: #d0d0ff;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #666666;
        }

        footer {
            text-align: center;
            padding: 0.5rem;
            margin-top: 1rem;
            border-top: 1px solid #404040;
            font-size: 0.7rem;
            color: #666666;
        }

        footer a {
            color: #e0e0e0;
            text-decoration: none;
        }

        footer a:hover {
            color: #b0b0b0;
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 24px;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .nav-link {
                align-self: flex-end;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .collapsible-content {
                grid-template-columns: 1fr;
            }


            .result-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .result-badges {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>Temoa Search</h1>
                <a href="/manage" class="nav-link">Manage</a>
            </div>
            <p class="subtitle">Semantic search for your vault</p>
        </header>

        <div class="search-box">
            <input
                type="text"
                id="query"
                placeholder="Search your vault..."
                autofocus
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
                spellcheck="false"
            >
            <button class="search-btn" onclick="search()">→</button>
        </div>

        <!-- Hybrid Search Toggle (only one at top) -->
        <div style="margin-bottom: 12px;">
            <div class="checkbox-group">
                <input type="checkbox" id="hybrid-search">
                <label for="hybrid-search">
                    <span>Hybrid</span>
                    <span class="info-icon" onclick="showTooltip(event, 'hybrid')">i</span>
                </label>
            </div>
        </div>

        <!-- Tooltip Popup -->
        <div id="tooltip-popup" class="tooltip-popup"></div>

        <!-- Collapsible Options (all controls consolidated) -->
        <div class="collapsible-header" onclick="toggleOptions()">
            <span class="arrow">▶</span>
            <span class="label">Options</span>
        </div>

        <div class="collapsible-content" id="options">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                <div class="checkbox-group">
                    <input type="checkbox" id="use-reranker" checked>
                    <label for="use-reranker">
                        <span>Rerank</span>
                        <span class="info-icon" onclick="showTooltip(event, 'rerank')">i</span>
                    </label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="expand-query" checked>
                    <label for="expand-query">
                        <span>Expand</span>
                        <span class="info-icon" onclick="showTooltip(event, 'expand')">i</span>
                    </label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="time-boost" checked>
                    <label for="time-boost">
                        <span>Recent</span>
                        <span class="info-icon" onclick="showTooltip(event, 'recent')">i</span>
                    </label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="show-json">
                    <label for="show-json">Show JSON</label>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="min-score">Min Score</label>
                <input type="number" id="min-score" min="0" max="1" step="0.05" value="0.30">
            </div>

            <div class="control-group">
                <label class="control-label" for="limit">Limit</label>
                <input type="number" id="limit" min="1" max="100" value="20">
            </div>

            <!-- Type Filtering -->
            <div class="control-group">
                <label class="control-label" for="include-types">Include Types</label>
                <div class="type-filter-row">
                    <select id="include-types" multiple size="3" class="type-select">
                        <option value="gleaning">Gleaning</option>
                        <option value="writering">Writering</option>
                        <option value="llmering">LLMering</option>
                        <option value="article">Article</option>
                        <option value="reference">Reference</option>
                        <option value="note">Note</option>
                        <option value="daily">Daily</option>
                    </select>
                    <button type="button" class="clear-btn" onclick="clearSelect('include-types')">Clear</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="exclude-types">Exclude Types</label>
                <div class="type-filter-row">
                    <select id="exclude-types" multiple size="3" class="type-select">
                        <option value="gleaning">Gleaning</option>
                        <option value="writering">Writering</option>
                        <option value="llmering">LLMering</option>
                        <option value="article">Article</option>
                        <option value="reference">Reference</option>
                        <option value="note">Note</option>
                        <option value="daily" selected>Daily</option>
                    </select>
                    <button type="button" class="clear-btn" onclick="clearSelect('exclude-types')">Clear</button>
                </div>
            </div>
        </div>

        <div class="error" id="error"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div style="margin-top: 8px;">Searching...</div>
        </div>

        <!-- Stats Panel - Collapsible -->
        <div class="stats-header" id="stats-header" onclick="toggleStats()" style="display: none;">
            <span class="arrow">▶</span>
            <div class="stats-summary" id="stats-summary"></div>
        </div>

        <div class="stats-details" id="stats-details" style="display: none;">
            <div class="stats-row">
                <span class="stats-row-label">Model:</span>
                <span class="stats-row-value" id="stat-model">-</span>
            </div>
            <div class="stats-row">
                <span class="stats-row-label">Mode:</span>
                <span class="stats-row-value" id="stat-mode">-</span>
            </div>
            <div class="stats-row">
                <span class="stats-row-label">Showing:</span>
                <span class="stats-row-value" id="stat-shown">-</span>
            </div>
            <div class="stats-row">
                <span class="stats-row-label">Filtered (score):</span>
                <span class="stats-row-value" id="stat-filtered-score">-</span>
            </div>
            <div class="stats-row">
                <span class="stats-row-label">Filtered (type):</span>
                <span class="stats-row-value" id="stat-filtered-type">-</span>
            </div>
            <div class="stats-row">
                <span class="stats-row-label">Filtered (daily):</span>
                <span class="stats-row-value" id="stat-filtered-daily">-</span>
            </div>
        </div>

        <div class="json-viewer" id="json-viewer"></div>

        <!-- Results Controls -->
        <div class="results-controls" id="results-controls" style="display: none;">
            <div id="results-header" class="results-header"></div>
            <div class="results-buttons">
                <button type="button" class="results-control-btn" onclick="collapseAllResults()" title="Collapse all results (c)">
                    Collapse All
                </button>
                <button type="button" class="results-control-btn" onclick="expandAllResults()" title="Expand all results (e)">
                    Expand All
                </button>
            </div>
        </div>

        <div id="results"></div>

        <!-- Vault Selector -->
        <div class="vault-selector" style="margin-top: 24px;">
            <label class="vault-selector-label">Vault:</label>
            <select id="vault-select" class="vault-select" onchange="onVaultChange()">
                <option value="">Loading vaults...</option>
            </select>
            <span id="vault-info" class="vault-info"></span>
        </div>

        <footer>
            <a href="https://github.com/pborenstein/temoa">temoa</a>
            &copy; 2025
            <a href="https://pborenstein.dev">Philip Borenstein</a>
            /
            Made in New England
            <svg style="display: inline-block; width: 20px; height: 12px; margin-left: 4px; vertical-align: middle;" viewBox="0 0 720 432" xmlns="http://www.w3.org/2000/svg">
                <rect fill="#BF0000" width="720" height="432"/>
                <rect fill="#FFFFFF" width="216" height="216"/>
                <path fill="#8B5C29" d="M114.15,170.029c0.014,5.968-0.477,11.827-0.515,17.716c-0.014,2.087,0.094,4.623,0.532,6.655c0.371,1.723,1.579,3.449,1.61,5.309c1.604,0.192,1.417,2.074,2.89,2.24c3.276,5.972-4.25,4.03-8.133,4.017c-2.596-0.009-5.317,0.471-7.708,0.374c-2.542-0.102-4.343-0.099-6.985,0.693c0.775-0.864,1.915-1.14,2.653-2.073c1.315-1.661,0.982-3.981,1.256-5.948c0.48-3.446,0.51-6.72,0.543-10.222c0.03-3.22,0.646-6.491,1.014-9.534c0.379-3.143,0.017-6.566,0.012-9.74"/>
                <path fill="#00A33D" d="M106.451,177.728c-0.659,0.771-2.116,2.905-3.317,2.956c-0.677,0.028-0.791-0.767-1.382-0.835c-1.293-0.15-2.95-0.131-4.254-0.084c-3.118,0.112-6.175,0.19-9.288-0.195c-5.419-0.671-9.691-0.84-14.821,1.004c-2.198,0.791-4.47,0.994-6.891,0.757c-2.634-0.257-5.513-0.324-8.1-0.917c-2.044-0.468-5.359-1.641-3.124-4.239c2.086-2.422,5.909-0.999,7.908-2.977c-5.916-0.576-11.514,1.969-17.245,1.207c-2.225-0.295-6.479-0.411-4.526-3.638c1.237-2.043,4.039-3.845,4.58-6.283c1.443-0.231,2.658-2.697,3.968-3.55c1.415-0.921,3.485-1.811,5.079-2.284c0.805-2.183-1.333-2.853-1.97-4.477c-0.942-2.404,1.583-3.115,2.159-5.085c0.276-0.067,0.552-0.133,0.829-0.197c0.064-0.276,0.129-0.554,0.196-0.83c0.945-0.081,2.306-1.621,2.98-2.273c0.959-0.927,3.269-2.896,3.555-3.886c-3.207,0.052-0.782-3.19,0.211-4.096c1.622-1.482,3.088-2.2,4.813-3.332c1.044-0.686,3.19-2.747,2.736-4.204c-0.56-1.798-3.338-1.085-4.04-2.892c-1.123-2.891,3.778-7.663,5.296-10.006c1.02-1.576,2.386-2.687,3.733-3.944c1.773-1.655,2.878-3.862,4.573-5.562c-3.283,0.325-6.411-0.641-9.504-0.528c-1.313-3.878,6.129-7.486,8.178-9.531c1.532-1.53,2.78-3.687,4.41-5.291c1.409-1.387,3.391-4.042,5.114-4.628c-2.75-0.049-5.117,2.07-7.951,1.488c-0.66-2.025,3.381-6.556,4.343-8.393c1.374-2.622,4.216-5.47,4.853-8.503c1.038-4.941-3.487-2.807-4.999-5.742c-1.485-2.881,4.017-4.102,4.961-5.451c0.809-1.155,0.862-3.811,0.021-4.947c-0.834-1.126-2.029-0.736-2.104-2.371c-0.132-2.932,3.591-5.725,4.49-8.142c0.585-1.572-0.176-3.076-0.337-4.579c-0.174-1.611,0.401-3.653,1.082-5.035c0.461-0.936,1.487-1.887,1.98-3.054c0.356-0.846,0.654-1.671,1.024-2.52c0.759-1.744,1.573-3.308,2.331-5.197c0.955-2.379,3.654-3.548,4.824-5.754c0.821-1.548,0.292-3.377,1.16-4.991c0.654-1.212,1.341-1.934,1.723-3.256c-0.185-0.106-0.278-0.277-0.284-0.515l4.106-3.592c0.703,1.062,0.862,2.783,1.405,3.979c0.49,1.08,0.988,2.156,1.548,3.204c0.768,1.439,1.522,2.849,2.084,4.2c1.38,3.323,2.236,6.437,3.909,9.645c0.758,1.453,1.75,2.673,2.355,4.079c0.779,1.809,0.788,3.547,1.253,5.419c0.43,1.733,1.391,3.207,1.798,4.881c0.417,1.71,2.248,4.455,2.006,6.087c-0.787,0.03-1.67,0.012-2.447,0.181c1.553,3.237,5.245,5.556,7.414,8.364c1.064,1.38,1.237,2.384,1.79,3.822c0.419,1.092,1.137,2.117,1.003,3.32c-0.06,0.541-0.567,1.026-0.594,1.754c-0.285,0.056-0.569,0.113-0.853,0.173c-0.58,1.76,0.959,3.569,1.704,5.048c1.098,2.178,0.684,2.021-0.389,4.066c-1.116,2.13-0.914,3.538-0.366,5.683c0.306,1.2,0.131,1.724,1.006,2.83c0.613,0.774,1.451,1.217,1.646,2.202c0.275,0.072,0.553,0.134,0.833,0.189c0.268,1.856,3.144,3.968,2.693,6.083c-0.533,2.495-3.82,1.715-0.563,4.817c2.303,2.195,8.194,5.46,7.652,9.463c-2.047,0.115-3.539,1.29-5.513,1.193c0.25,1.777,3.247,2.755,4.385,4.131c1.618,1.956,2.957,4.649,5.307,5.831c2.662,1.338,11.009,4.133,4.625,7.38c-1.801,0.915-10.238,0.596-9.015,3.635c1.022,2.539,5.035,1.692,1.314,4.172c-2.718,1.812-4.869,1.769-8.094,2.18c0.958,1.79,4.134,4.129,5.709,4.846c1.166,0.532,2.744,0.302,4.004,0.662c3.18,0.906,5.853,2.899,8.916,4.088c2.311,0.897,4.728,1.903,6.799,2.995c1.963,1.036,3.902,3.257,5.921,4.206c-2.742,1.363-8.363,3.684-11.745,3.556c-1.226-0.047-1.769-0.463-3.103-0.333c-1.995,0.195-3.461,0.956-5.506,0.78c3.402,1.388,8.062,0.741,10.97,3.062c2.256,1.8,2.247,4.787,5.378,5.921c2.095,0.758,4.279,0.754,6.477,1.388c1.771,0.512,3.354,0.634,5.062,1.057c1.856,0.458,1.959,1.229,2.508,2.864c-0.933,0.627-2.056,0.844-3.046,1.4c-1.701,0.958-2.596,2.857-4.1,3.766c-2.162,1.306-6.182,2.48-8.712,2.148c-3.652-0.479-6.491,0.374-10.233,0.496c-2.258,0.075-4.304,1.029-6.563,1.107c1.459,1.327,2.812,2.674,4.452,3.811c1.666,1.155,3.636,1.812,5.079,3.412c-0.984,2.847-8.668,1.344-10.879,0.849c-1.995-0.448-3.829-0.442-5.926-0.451c-3.283-0.015-5.539-0.708-8.729-1.309c-9.681-1.825-16.693-10.305-27.197-8.89c-0.019,0.789,0.374,1.167,0.973,1.464L106.451,177.728z"/>
            </svg>
            /
            <a href="/docs">API</a>
            •
            <span style="color: #555555;">v{{VERSION}}</span>
        </footer>
    </div>

    <script>
        const queryInput = document.getElementById('query');
        const minScoreInput = document.getElementById('min-score');
        const limitInput = document.getElementById('limit');
        const hybridSearchCheckbox = document.getElementById('hybrid-search');
        const useRerankerCheckbox = document.getElementById('use-reranker');
        const expandQueryCheckbox = document.getElementById('expand-query');
        const timeBoostCheckbox = document.getElementById('time-boost');
        const includeTypesSelect = document.getElementById('include-types');
        const excludeTypesSelect = document.getElementById('exclude-types');
        const showJsonCheckbox = document.getElementById('show-json');
        const resultsDiv = document.getElementById('results');
        const resultsHeader = document.getElementById('results-header');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const searchBtn = document.querySelector('.search-btn');
        const statsHeader = document.getElementById('stats-header');
        const statsDetails = document.getElementById('stats-details');
        const jsonViewer = document.getElementById('json-viewer');
        const vaultSelect = document.getElementById('vault-select');
        const vaultInfo = document.getElementById('vault-info');

        // ========================================
        // State Management
        // ========================================
        const STORAGE_VERSION = 1;
        const STORAGE_KEY = `temoa_v${STORAGE_VERSION}_ui_state`;

        const state = {
            query: '',
            results: [],
            vaults: [],  // List of available vaults
            currentVault: null,  // Currently selected vault name
            defaultVault: null,  // Default vault from config
            filters: {
                minScore: 0.3,
                limit: 20,
                hybrid: false,
                rerank: true,
                expandQuery: true,
                timeBoost: true,
                includeTypes: [],
                excludeTypes: ['daily']
            },
            ui: {
                expandedResults: new Set(),  // Track which results are expanded
                statsExpanded: false,
                optionsExpanded: false,  // Renamed from advancedExpanded
                showJson: false
            },
            currentRequestId: 0  // Prevent race conditions
        };

        // Load UI state from localStorage
        function loadState() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return;

                const data = JSON.parse(stored);

                // Restore vault preference (fallback for when no URL param)
                if (data.currentVault) {
                    state.currentVault = data.currentVault;
                }

                // Restore UI preferences
                if (data.ui) {
                    // Convert expandedResults array back to Set
                    if (Array.isArray(data.ui.expandedResults)) {
                        state.ui.expandedResults = new Set(data.ui.expandedResults);
                    }
                    state.ui.statsExpanded = data.ui.statsExpanded || false;
                    state.ui.optionsExpanded = data.ui.optionsExpanded || data.ui.advancedExpanded || false;  // Backward compat
                    state.ui.showJson = data.ui.showJson || false;
                }
            } catch (err) {
                console.warn('Failed to load state from localStorage:', err);
            }
        }

        // Save UI state to localStorage
        function saveState() {
            try {
                const toSave = {
                    currentVault: state.currentVault,  // Remember last selected vault
                    ui: {
                        expandedResults: Array.from(state.ui.expandedResults),  // Convert Set to array
                        statsExpanded: state.ui.statsExpanded,
                        optionsExpanded: state.ui.optionsExpanded,
                        showJson: state.ui.showJson
                    }
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            } catch (err) {
                console.warn('Failed to save state to localStorage:', err);
            }
        }

        // Update state and persist
        function updateState(updates) {
            Object.assign(state, updates);
            saveState();
        }

        // Load state on startup
        loadState();

        // ========================================
        // Tooltip System
        // ========================================

        const tooltipData = {
            hybrid: {
                title: 'Hybrid Search',
                description: 'Combines keyword (BM25) and semantic search.',
                useWhen: 'Looking for specific terms or exact phrases.',
                dontUse: 'When searching by concept or meaning only.'
            },
            rerank: {
                title: 'Smart Re-ranking',
                description: 'After the initial search, this runs each result through a second model that looks at the query and document together. Slower but puts the best matches at the top.',
                useWhen: 'You want the most relevant results first.',
                dontUse: 'When speed is more important than accuracy.'
            },
            expand: {
                title: 'Query Expansion',
                description: 'Automatically adds related terms to short queries.',
                useWhen: 'Using 1-3 word queries.',
                dontUse: 'With long, specific queries or exact phrase searches.'
            },
            recent: {
                title: 'Time Boost',
                description: 'Gives higher scores to recently created/modified documents.',
                useWhen: 'You want fresh, recent content.',
                dontUse: 'When searching for older reference material.'
            }
        };

        let currentTooltip = null;

        function showTooltip(event, key) {
            event.stopPropagation();
            event.preventDefault();

            const tooltip = document.getElementById('tooltip-popup');
            const data = tooltipData[key];

            if (!data) return;

            // Toggle if clicking the same tooltip
            if (currentTooltip === key && tooltip.classList.contains('active')) {
                hideTooltip();
                return;
            }

            currentTooltip = key;

            // Build tooltip content
            tooltip.innerHTML = `
                <div class="tooltip-title">${data.title}</div>
                <div class="tooltip-section">${data.description}</div>
                <div class="tooltip-section">
                    <div class="tooltip-label">Use when:</div>
                    ${data.useWhen}
                </div>
                <div class="tooltip-section">
                    <div class="tooltip-label">Don't use:</div>
                    ${data.dontUse}
                </div>
            `;

            // Position tooltip near the clicked icon
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = `${rect.left}px`;
            tooltip.style.top = `${rect.bottom + 8}px`;

            // Adjust if tooltip goes off screen
            setTimeout(() => {
                const tooltipRect = tooltip.getBoundingClientRect();
                if (tooltipRect.right > window.innerWidth) {
                    tooltip.style.left = `${window.innerWidth - tooltipRect.width - 16}px`;
                }
                if (tooltipRect.bottom > window.innerHeight) {
                    tooltip.style.top = `${rect.top - tooltipRect.height - 8}px`;
                }
            }, 0);

            tooltip.classList.add('active');
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip-popup');
            tooltip.classList.remove('active');
            currentTooltip = null;
        }

        // Close tooltip when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.info-icon') && !e.target.closest('#tooltip-popup')) {
                hideTooltip();
            }
        });

        // ========================================
        // Vault Management
        // ========================================

        // Get vault from URL parameter, localStorage, or default (priority order)
        function getCurrentVault() {
            // Priority 1: URL parameter (for shareable links)
            const urlParams = new URLSearchParams(window.location.search);
            const urlVault = urlParams.get('vault');
            if (urlVault) {
                return urlVault;
            }

            // Priority 2: localStorage (remember last used)
            if (state.currentVault) {
                return state.currentVault;
            }

            // Priority 3: Default vault from config
            return state.defaultVault;
        }

        // Fetch available vaults from API
        async function fetchVaults() {
            try {
                const response = await fetch('/vaults');
                if (!response.ok) {
                    throw new Error('Failed to fetch vaults');
                }

                const data = await response.json();
                state.vaults = data.vaults;
                state.defaultVault = data.default_vault;

                // Populate vault selector
                populateVaultSelector();

                // Set current vault based on priority
                const selectedVault = getCurrentVault();
                if (selectedVault) {
                    state.currentVault = selectedVault;
                    vaultSelect.value = selectedVault;
                    updateVaultInfo();
                }
            } catch (err) {
                console.error('Failed to fetch vaults:', err);
                vaultSelect.innerHTML = '<option value="">Error loading vaults</option>';
            }
        }

        // Populate vault selector dropdown
        function populateVaultSelector() {
            vaultSelect.innerHTML = '';

            state.vaults.forEach(vault => {
                const option = document.createElement('option');
                option.value = vault.name;
                option.textContent = vault.name;
                vaultSelect.appendChild(option);
            });
        }

        // Update vault info display
        function updateVaultInfo() {
            const vault = state.vaults.find(v => v.name === state.currentVault);
            if (!vault) {
                vaultInfo.innerHTML = '';
                return;
            }

            vaultInfo.innerHTML = '';

            if (vault.is_default) {
                const badge = document.createElement('span');
                badge.className = 'vault-badge default';
                badge.textContent = 'default';
                vaultInfo.appendChild(badge);
            }

            if (vault.indexed) {
                const badge = document.createElement('span');
                badge.className = 'vault-badge indexed';
                badge.textContent = `${vault.file_count} files indexed`;
                vaultInfo.appendChild(badge);
            } else {
                const badge = document.createElement('span');
                badge.className = 'vault-badge';
                badge.textContent = 'not indexed';
                vaultInfo.appendChild(badge);
            }
        }

        // Handle vault change
        function onVaultChange() {
            state.currentVault = vaultSelect.value;
            saveState();
            updateVaultInfo();

            // Update URL parameter (for shareable links)
            const url = new URL(window.location);
            url.searchParams.set('vault', state.currentVault);
            window.history.replaceState({}, '', url);

            // Clear results (vault changed, old results not relevant)
            resultsDiv.innerHTML = '';
            resultsHeader.style.display = 'none';
            statsHeader.style.display = 'none';
            jsonViewer.classList.remove('active');
        }

        // Helper function to get selected values from multi-select
        function getSelectedValues(selectElement) {
            return Array.from(selectElement.selectedOptions)
                .map(opt => opt.value)
                .join(',');
        }

        // Helper function to clear select
        function clearSelect(selectId) {
            const select = document.getElementById(selectId);
            Array.from(select.options).forEach(opt => opt.selected = false);
        }

        // Toggle options (consolidated from controls + advanced options)
        function toggleOptions() {
            const content = document.getElementById('options');
            const header = document.querySelector('.collapsible-header');

            state.ui.optionsExpanded = !state.ui.optionsExpanded;
            saveState();

            content.classList.toggle('expanded');
            header.classList.toggle('expanded');
        }

        // Toggle stats
        function toggleStats() {
            state.ui.statsExpanded = !state.ui.statsExpanded;
            saveState();

            statsDetails.classList.toggle('expanded');
            statsHeader.classList.toggle('expanded');
        }

        // Restore UI state on load
        function restoreUIState() {
            // Restore stats panel state
            if (state.ui.statsExpanded) {
                statsDetails.classList.add('expanded');
                statsHeader.classList.add('expanded');
            }

            // Restore options state
            if (state.ui.optionsExpanded) {
                const content = document.getElementById('options');
                const header = document.querySelector('.collapsible-header');
                content.classList.add('expanded');
                header.classList.add('expanded');
            }

            // Restore JSON viewer state
            if (state.ui.showJson) {
                showJsonCheckbox.checked = true;
            }
        }

        showJsonCheckbox.addEventListener('change', (e) => {
            state.ui.showJson = e.target.checked;
            saveState();

            if (e.target.checked && window.lastSearchData) {
                displayJson(window.lastSearchData);
            } else {
                jsonViewer.classList.remove('active');
            }
        });

        window.addEventListener('load', async () => {
            await fetchVaults();  // Load vault list first
            restoreUIState();
            queryInput.focus();
        });

        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                search();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.matches('input, textarea, select')) return;

            // 'c' to collapse all results
            if (e.key === 'c') {
                e.preventDefault();
                collapseAllResults();
            }

            // 'e' to expand all results
            if (e.key === 'e') {
                e.preventDefault();
                expandAllResults();
            }
        });

        async function search() {
            const query = queryInput.value.trim();

            if (!query) {
                showError('Please enter a search query');
                return;
            }

            // Increment request ID to detect stale responses
            const requestId = ++state.currentRequestId;

            const minScore = parseFloat(minScoreInput.value) || 0.3;
            const limit = parseInt(limitInput.value) || 20;
            const hybrid = hybridSearchCheckbox.checked;
            const rerank = useRerankerCheckbox.checked;
            const expandQuery = expandQueryCheckbox.checked;
            const timeBoost = timeBoostCheckbox.checked;
            const includeTypes = getSelectedValues(includeTypesSelect);
            const excludeTypes = getSelectedValues(excludeTypesSelect);

            // Update state
            state.query = query;
            state.filters.minScore = minScore;
            state.filters.limit = limit;
            state.filters.hybrid = hybrid;
            state.filters.rerank = rerank;
            state.filters.expandQuery = expandQuery;
            state.filters.timeBoost = timeBoost;

            errorDiv.classList.remove('active');
            loadingDiv.classList.add('active');
            resultsDiv.innerHTML = '';
            document.getElementById('results-controls').style.display = 'none';
            statsHeader.style.display = 'none';
            statsDetails.classList.remove('expanded');
            statsHeader.classList.remove('expanded');
            jsonViewer.classList.remove('active');
            searchBtn.disabled = true;

            try {
                let url = `/search?q=${encodeURIComponent(query)}&limit=${limit}&min_score=${minScore}&hybrid=${hybrid}&rerank=${rerank}&expand_query=${expandQuery}&time_boost=${timeBoost}`;

                // Add vault parameter
                if (state.currentVault) {
                    url += `&vault=${encodeURIComponent(state.currentVault)}`;
                }

                if (includeTypes) {
                    url += `&include_types=${encodeURIComponent(includeTypes)}`;
                }
                if (excludeTypes) {
                    url += `&exclude_types=${encodeURIComponent(excludeTypes)}`;
                }

                const response = await fetch(url);

                if (!response.ok) {
                    const error = await response.json();
                    // Handle FastAPI validation errors (detail is an array)
                    let errorMessage = 'Search failed';
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            // Validation error format: extract message from first error
                            errorMessage = error.detail[0]?.msg || JSON.stringify(error.detail[0]);
                        } else if (typeof error.detail === 'string') {
                            errorMessage = error.detail;
                        }
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                // Ignore stale responses (race condition protection)
                if (requestId !== state.currentRequestId) {
                    console.log('Ignoring stale response for request', requestId);
                    return;
                }

                state.results = data.results || [];
                window.lastSearchData = data;

                displayResults(data);
                displayStats(data);

                if (showJsonCheckbox.checked) {
                    displayJson(data);
                }

            } catch (error) {
                // Only show error if this is still the current request
                if (requestId === state.currentRequestId) {
                    showError(error.message || 'Failed to search. Please try again.');
                    console.error('Search error:', error);
                }
            } finally {
                // Only re-enable if this is still the current request
                if (requestId === state.currentRequestId) {
                    loadingDiv.classList.remove('active');
                    searchBtn.disabled = false;
                }
            }
        }

        function displayStats(data) {
            const { model, total, min_score, filtered_count, search_mode, results } = data;

            const totalResults = total || 0;
            const shownResults = results?.length || 0;

            // Hide stats if no results
            if (totalResults === 0) {
                statsHeader.style.display = 'none';
                statsDetails.style.display = 'none';
                return;
            }

            const scoreFiltered = filtered_count?.by_score || 0;
            const typeFiltered = filtered_count?.by_type || 0;
            const dailyFiltered = filtered_count?.by_daily || 0;

            // Update summary (compact one-liner)
            const summary = `<strong>${totalResults}</strong> results`;
            document.getElementById('stats-summary').innerHTML = summary;

            // Update details
            document.getElementById('stat-model').textContent = model || 'unknown';
            document.getElementById('stat-mode').textContent = search_mode || '-';
            document.getElementById('stat-shown').textContent =
                shownResults < totalResults ? `${shownResults} of ${totalResults}` : 'All results';
            document.getElementById('stat-filtered-score').textContent = scoreFiltered;
            document.getElementById('stat-filtered-type').textContent = typeFiltered;
            document.getElementById('stat-filtered-daily').textContent = dailyFiltered;

            // Show the stats header
            statsHeader.style.display = 'flex';
        }

        function displayJson(data) {
            jsonViewer.textContent = JSON.stringify(data, null, 2);
            jsonViewer.classList.add('active');
        }

        function displayResults(data) {
            const { query, results, total, expanded_query } = data;
            const resultsControls = document.getElementById('results-controls');

            if (!results || results.length === 0) {
                // Create empty state with createElement
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                const emptyText = document.createElement('div');
                emptyText.textContent = `No results found for "${query}"`;
                emptyState.appendChild(emptyText);
                resultsDiv.replaceChildren(emptyState);
                resultsControls.style.display = 'none';
                return;
            }

            // Show query expansion if it occurred
            let headerText = `Found ${total} results for "${query}"`;
            if (expanded_query) {
                headerText += ` (expanded to: "${expanded_query}")`;
            }
            resultsHeader.textContent = headerText;
            resultsControls.style.display = 'flex';

            // Create results table container
            const table = document.createElement('div');
            table.className = 'results-table';

            // Create result cards using factory functions with error boundaries
            const cards = results.map(result =>
                safeRender(() => {
                    const expanded = state.ui.expandedResults.has(result.relative_path);
                    return createResultCard(result, expanded);
                })
            );

            table.append(...cards);
            resultsDiv.replaceChildren(table);
        }

        // ========================================
        // Result Card Toggle Logic
        // ========================================

        function toggleResultExpanded(resultId) {
            if (state.ui.expandedResults.has(resultId)) {
                state.ui.expandedResults.delete(resultId);
            } else {
                state.ui.expandedResults.add(resultId);
            }
            saveState();

            // Update the specific card's DOM
            const card = document.querySelector(`[data-result-id="${CSS.escape(resultId)}"]`);
            if (!card) return;

            const isExpanded = state.ui.expandedResults.has(resultId);
            card.classList.toggle('expanded', isExpanded);

            // Get the result data to create details if expanding
            if (isExpanded && !card.querySelector('.result-details')) {
                const result = state.results.find(r => r.relative_path === resultId);
                if (result) {
                    const details = createResultDetails(result);
                    card.appendChild(details);
                }
            } else if (!isExpanded) {
                const details = card.querySelector('.result-details');
                if (details) {
                    details.remove();
                }
            }
        }

        function collapseAllResults() {
            state.ui.expandedResults.clear();
            saveState();

            // Update all cards
            document.querySelectorAll('.result-row').forEach(card => {
                card.classList.remove('expanded');
                const details = card.querySelector('.result-details');
                if (details) {
                    details.remove();
                }
            });
        }

        function expandAllResults() {
            // Add all result IDs to expanded set
            state.results.forEach(result => {
                state.ui.expandedResults.add(result.relative_path);
            });
            saveState();

            // Update all cards
            document.querySelectorAll('.result-row').forEach(card => {
                const resultId = card.dataset.resultId;
                if (!resultId) return;

                card.classList.add('expanded');
                if (!card.querySelector('.result-details')) {
                    const result = state.results.find(r => r.relative_path === resultId);
                    if (result) {
                        const details = createResultDetails(result);
                        card.appendChild(details);
                    }
                }
            });
        }

        // Event delegation for result card clicks
        resultsDiv.addEventListener('click', (e) => {
            const card = e.target.closest('.result-row');
            if (!card) return;

            // Don't toggle if clicking on a link
            if (e.target.tagName === 'A') return;

            const resultId = card.dataset.resultId;
            if (resultId) {
                toggleResultExpanded(resultId);
            }
        });

        // ========================================
        // Component Factory Functions (Safe DOM)
        // ========================================

        function createBadge(className, content, href = null) {
            const badge = document.createElement(href ? 'a' : 'span')
            badge.className = className
            badge.textContent = content
            if (href) {
                badge.href = href
            }
            return badge
        }

        function createTag(tagName) {
            const tag = document.createElement('span')
            tag.className = 'tag'
            tag.textContent = `#${tagName}`
            return tag
        }

        function createResultHeader(result) {
            const header = document.createElement('div')
            header.className = 'result-header'

            // Title link
            const titleLink = document.createElement('a')
            titleLink.className = 'result-title-link'
            titleLink.href = result.obsidian_uri
            titleLink.textContent = result.title || result.relative_path
            header.appendChild(titleLink)

            // Badges container
            const badgesDiv = document.createElement('div')
            badgesDiv.className = 'result-badges'

            // Type badge
            if (result.frontmatter?.type) {
                let type = result.frontmatter.type
                if (Array.isArray(type)) {
                    type = type.join(', ')
                } else {
                    type = String(type)
                }
                badgesDiv.appendChild(createBadge('type-badge', type))
            }

            // Project badge
            if (result.frontmatter?.project) {
                const vaultName = result.obsidian_uri.split('/')[3]
                let project = result.frontmatter.project
                if (Array.isArray(project)) project = project[0]
                if (typeof project !== 'string') project = String(project)
                const projectName = project.replace(/[\[\]]/g, '')
                const projectUri = `obsidian://vault/${vaultName}/${encodeURIComponent(projectName)}`
                badgesDiv.appendChild(createBadge('project-badge', projectName, projectUri))
            }

            // Score badge
            const scoreDiv = document.createElement('div')
            scoreDiv.className = 'result-score-badge'
            if (result.bm25_score !== undefined) {
                scoreDiv.textContent = `${((result.similarity_score || 0) * 100).toFixed(1)}% | ${result.bm25_score.toFixed(1)}`
            } else {
                scoreDiv.textContent = `${((result.similarity_score || 0) * 100).toFixed(1)}%`
            }
            badgesDiv.appendChild(scoreDiv)

            // Tags (inline after score)
            if (result.tags && result.tags.length) {
                result.tags.forEach(tag => {
                    badgesDiv.appendChild(createTag(tag))
                })
            }

            header.appendChild(badgesDiv)
            return header
        }

        function createResultDetails(result) {
            const details = document.createElement('div')
            details.className = 'result-details'

            // Meta info (path, date)
            const meta = document.createElement('div')
            meta.className = 'result-meta'

            const pathItem = document.createElement('div')
            pathItem.className = 'result-meta-item'
            const pathSpan = document.createElement('span')
            pathSpan.className = 'result-path'
            pathSpan.textContent = result.relative_path
            pathItem.appendChild(pathSpan)
            meta.appendChild(pathItem)

            if (result.created_date) {
                const dateItem = document.createElement('div')
                dateItem.className = 'result-meta-item'
                const dateSpan = document.createElement('span')
                dateSpan.textContent = result.created_date
                dateItem.appendChild(dateSpan)
                meta.appendChild(dateItem)
            }

            details.appendChild(meta)

            // Description
            if (result.description) {
                const desc = document.createElement('div')
                desc.className = 'result-description'
                desc.textContent = result.description
                details.appendChild(desc)
            }

            // Tags
            if (result.tags && result.tags.length) {
                const tagsDiv = document.createElement('div')
                tagsDiv.className = 'result-tags'
                result.tags.forEach(tag => {
                    tagsDiv.appendChild(createTag(tag))
                })
                details.appendChild(tagsDiv)
            }

            return details
        }

        function createResultCard(result, expanded = false) {
            const card = document.createElement('div')
            card.className = 'result-row'
            if (expanded) {
                card.classList.add('expanded')
            }
            card.dataset.resultId = result.relative_path

            // Header (always visible)
            const header = createResultHeader(result)
            card.appendChild(header)

            // Details (conditionally visible)
            if (expanded) {
                const details = createResultDetails(result)
                card.appendChild(details)
            }

            return card
        }

        function createErrorCard() {
            const card = document.createElement('div')
            card.className = 'result-row error'
            card.textContent = 'Failed to render result'
            return card
        }

        // ========================================
        // Error Boundaries
        // ========================================

        function safeRender(renderFn, fallback = null) {
            try {
                return renderFn();
            } catch (err) {
                console.error('Render error:', err);
                showError('Something went wrong rendering results. Please refresh.');
                return fallback || createErrorCard();
            }
        }

        // ========================================
        // Utility Functions
        // ========================================

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // PWA Service Worker Registration
        // ========================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
