<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Temoa</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Temoa">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <style>
        /* ========================================
           GLOBAL STYLES
           ======================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #1a1a1a;
            line-height: 1.5;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        /* ========================================
           HEADER (shared between views)
           ======================================== */
        header {
            background: #1a1a1a;
            border-bottom: 1px solid #333333;
            padding: 12px 16px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle-btn {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
            background: transparent;
            color: #888888;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .view-toggle-btn:hover {
            background: #333333;
            color: #c0c0c0;
        }

        .view-toggle-btn.active {
            background: #4a6a8a;
            color: #ffffff;
        }

        .nav-link {
            color: #888888;
            text-decoration: none;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        /* Search controls row */
        .search-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        /* Search history bar */
        .search-history-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 32px;
            padding: 0 4px;
        }

        .history-items {
            flex: 1;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .history-chip {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 12px;
            color: #b0b0b0;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .history-chip:hover {
            background: #3a3a3a;
            border-color: #4a6a8a;
            color: #e0e0e0;
        }

        .clear-history-btn-inline {
            background: transparent;
            border: 1px solid #404040;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            color: #666666;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .clear-history-btn-inline:hover {
            background: #3a3a3a;
            border-color: #cc4444;
            color: #cc4444;
        }

        .search-input {
            width: 100%;
            padding: 10px 14px;
            font-size: 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
        }

        .search-input:focus {
            border-color: #666666;
        }

        .vault-select,
        .profile-select {
            padding: 10px 14px;
            font-size: 14px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
            cursor: pointer;
            min-width: 140px;
        }

        .vault-select:focus,
        .profile-select:focus {
            border-color: #666666;
        }

        .run-btn {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            background: #4a6a8a;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .run-btn:hover {
            background: #5a7a9a;
        }

        .run-btn:active {
            background: #3a5a7a;
        }

        .run-btn:disabled {
            background: #333333;
            color: #666666;
            cursor: not-allowed;
        }

        /* ========================================
           LIST VIEW MODE
           ======================================== */
        .list-view-container {
            display: none;
            height: calc(100vh - 110px);
            overflow: hidden;
        }

        .list-view-container.active {
            display: flex;
        }

        .list-main {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }

        .list-sidebar {
            width: 200px;
            background: #222222;
            border-left: 1px solid #333333;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section h3 {
            font-size: 12px;
            font-weight: 500;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 6px 8px;
            font-size: 13px;
            color: #aaaaaa;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            transition: all 0.15s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .clear-history-btn {
            width: 100%;
            padding: 6px;
            font-size: 11px;
            background: #2a2a2a;
            color: #888888;
            border: 1px solid #333333;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
        }

        .clear-history-btn:hover {
            background: #333333;
            color: #aaaaaa;
        }

        /* ========================================
           EXPLORER VIEW MODE
           ======================================== */
        .explorer-view-container {
            display: none;
            height: calc(100vh - 110px);
            overflow: hidden;
        }

        .explorer-view-container.active {
            display: block;
        }

        .explorer-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 16px;
            padding: 16px;
            height: 100%;
        }

        .pane {
            background: #222222;
            border: 1px solid #333333;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pane-header {
            padding: 12px 16px;
            border-bottom: 1px solid #333333;
            font-size: 14px;
            font-weight: 500;
            color: #aaaaaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-btn {
            background: #3a3a3a;
            color: #888888;
            border: 1px solid #4a4a4a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .help-btn:hover {
            background: #4a6a8a;
            color: #ffffff;
            border-color: #5a7a9a;
        }

        .help-panel {
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 16px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .help-panel h2 {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333333;
        }

        .help-panel h3 {
            font-size: 13px;
            font-weight: 600;
            color: #cccccc;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .help-panel p {
            font-size: 12px;
            color: #b0b0b0;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .help-panel ul {
            font-size: 12px;
            color: #b0b0b0;
            line-height: 1.6;
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .help-panel code {
            background: #2a2a2a;
            color: #88aa88;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
        }

        .help-panel .score-example {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 11px;
            color: #aaaaaa;
        }

        .pane-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Scrollbar styles */
        .pane-content::-webkit-scrollbar,
        .list-main::-webkit-scrollbar,
        .list-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .pane-content::-webkit-scrollbar-track,
        .list-main::-webkit-scrollbar-track,
        .list-sidebar::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .pane-content::-webkit-scrollbar-thumb,
        .list-main::-webkit-scrollbar-thumb,
        .list-sidebar::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .pane-content::-webkit-scrollbar-thumb:hover,
        .list-main::-webkit-scrollbar-thumb:hover,
        .list-sidebar::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* Empty states */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666666;
            text-align: center;
            padding: 32px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.6;
        }

        /* ========================================
           EXPLORER CONTROLS (MIXER)
           ======================================== */
        .mixer-section {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .mixer-section h3 {
            font-size: 12px;
            font-weight: 500;
            color: #aaaaaa;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mixer-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .mixer-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .mixer-item label {
            font-size: 11px;
            color: #888888;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mixer-item input[type="number"] {
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
            width: 100%;
        }

        .mixer-item input[type="number"]:focus {
            border-color: #666666;
        }

        /* Balance slider */
        .balance-slider {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .balance-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: #888888;
        }

        .balance-labels > span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .balance-value {
            font-size: 9px;
            color: #666666;
        }

        .balance-track {
            position: relative;
            height: 6px;
            background: linear-gradient(to right, #4a6a8a, #8a6a4a);
            border-radius: 3px;
        }

        .balance-input {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 100%;
            height: 18px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            margin: 0;
        }

        .balance-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 2px solid #1a1a1a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .balance-input::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 2px solid #1a1a1a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        /* Checkbox items */
        .checkbox-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 12px;
            color: #c0c0c0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Tooltips */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3a3a3a;
            color: #888888;
            font-size: 9px;
            font-weight: 600;
            cursor: help;
            flex-shrink: 0;
        }

        .tooltip-wrapper {
            position: relative;
            display: inline-flex;
        }

        .tooltip {
            position: fixed;
            background: #333333;
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 11px;
            color: #d0d0d0;
            white-space: normal;
            width: 240px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            text-transform: none;
            text-align: left;
            pointer-events: none;
        }

        /* Position tooltip dynamically via JS, but default fallback */
        .tooltip-wrapper:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        .tooltip strong {
            color: #ffffff;
            font-weight: 600;
        }

        .tooltip em {
            color: #aaaaaa;
            font-style: italic;
        }

        .tooltip-wrapper:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Fetch dirty indicator */
        .server-section {
            border-color: #333333;
        }

        .server-section.dirty {
            border-color: #665500;
        }

        .refetch-notice {
            display: none;
            font-size: 11px;
            color: #cc8800;
            margin-top: 10px;
            padding: 6px 10px;
            background: rgba(204, 136, 0, 0.1);
            border-radius: 4px;
        }

        .server-section.dirty .refetch-notice {
            display: block;
        }

        /* Action buttons */
        .action-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }

        .action-btn {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #c0c0c0;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }

        .action-btn:hover {
            background: #333333;
            border-color: #4a4a4a;
        }

        .action-btn:active {
            background: #1a1a1a;
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            color: #888888;
            font-size: 14px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #333333;
            border-top-color: #888888;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================
           RESULT CARDS
           ======================================== */
        .results-table {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-row {
            background: #1a1a1a;
            padding: 12px 14px;
            border-radius: 6px;
            border: 1px solid #333333;
            transition: all 0.2s;
            cursor: pointer;
        }

        .result-row:hover {
            background: #252525;
            border-color: #404040;
        }

        .result-row.selected {
            border-color: #4a6a8a;
            background: #1a2a3a;
        }

        .result-title-link {
            font-weight: 600;
            color: #c0c0c0;
            text-decoration: none;
            font-size: 14px;
            line-height: 1.3;
            display: block;
            margin-bottom: 4px;
        }

        .result-title-link:hover {
            color: #e0e0e0;
            text-decoration: underline;
        }

        .result-path {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #666666;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .result-dates {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #666666;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .result-description {
            color: #999999;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 6px;
        }

        .tag {
            background: #2a2a2a;
            color: #888888;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            border: 1px solid #333333;
        }

        .result-scores-compact {
            font-size: 9px;
            color: #555555;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .type-badge,
        .project-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #2a2a2a;
            color: #888888;
            border: 1px solid #333333;
            text-decoration: none;
            white-space: nowrap;
        }

        .type-badge {
            background: #2a3a2a;
            color: #88aa88;
            border-color: #3a4a3a;
        }

        .project-badge {
            background: #2a2a3a;
            color: #8888aa;
            border-color: #3a3a4a;
        }

        .project-badge:hover {
            background: #3a3a4a;
            color: #aaaacc;
        }

        /* ========================================
           INSPECTOR PANE
           ======================================== */
        .inspector-section {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .inspector-section h3 {
            font-size: 11px;
            font-weight: 600;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .inspector-title {
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .inspector-path {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 10px;
            color: #666666;
            margin-bottom: 10px;
        }

        .inspector-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 4px 0;
            font-size: 11px;
            border-bottom: 1px solid #252525;
        }

        .inspector-row:last-child {
            border-bottom: none;
        }

        .inspector-label {
            color: #777777;
            flex-shrink: 0;
            margin-right: 8px;
            min-width: 80px;
        }

        .inspector-value {
            color: #b0b0b0;
            text-align: right;
            word-break: break-word;
        }

        .inspector-value.mono {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 10px;
        }

        .inspector-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .inspector-tag {
            background: #2a2a2a;
            color: #888888;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            border: 1px solid #333333;
        }

        .score-bar {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            color: #c0c0c0;
            min-width: 50px;
            text-align: right;
        }

        .score-visual {
            flex: 1;
            height: 4px;
            background: #2a2a2a;
            border-radius: 2px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a6a8a, #6a8aaa);
            transition: width 0.3s ease;
        }

        .inspector-link {
            display: inline-block;
            color: #6a8aaa;
            text-decoration: none;
            font-size: 11px;
            padding: 4px 8px;
            border: 1px solid #3a4a5a;
            border-radius: 4px;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .inspector-link:hover {
            background: #2a3a4a;
            border-color: #4a6a8a;
            color: #8aaacc;
        }

        .close-inspector {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a2a2a;
            border: 1px solid #333333;
            border-radius: 4px;
            color: #888888;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s;
        }

        .close-inspector:hover {
            background: #333333;
            color: #c0c0c0;
        }

        /* ========================================
           MOBILE RESPONSIVE
           ======================================== */
        @media (max-width: 1024px) {
            .explorer-grid {
                grid-template-columns: 240px 1fr 280px;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 12px;
            }

            .header-top {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .search-controls {
                flex-direction: column;
                gap: 8px;
            }

            .vault-select,
            .profile-select {
                width: 100%;
            }

            .list-view-container {
                height: calc(100vh - 200px);
            }

            .explorer-view-container {
                height: calc(100vh - 200px);
            }

            .explorer-grid {
                grid-template-columns: 1fr;
                padding: 12px;
                gap: 12px;
            }

            .pane {
                min-height: 300px;
            }

            /* Mobile: Controls accordion (collapsed by default) */
            #controls-pane {
                max-height: 48px;
                transition: max-height 0.3s ease;
            }

            #controls-pane.expanded {
                max-height: 600px;
            }

            .pane-header {
                cursor: pointer;
                user-select: none;
            }

            .pane-header::after {
                content: '‚ñº';
                float: right;
                font-size: 12px;
                transition: transform 0.3s;
            }

            #controls-pane.expanded .pane-header::after {
                transform: rotate(180deg);
            }

            /* Mobile: Inspector as drawer */
            #inspector-pane {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 70vh;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 100;
                border-radius: 12px 12px 0 0;
            }

            #inspector-pane.visible {
                transform: translateY(0);
            }

            .close-inspector {
                display: flex;
            }
        }

        @media (min-width: 769px) {
            .close-inspector {
                display: none;
            }
        }

    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <h1>Temoa</h1>
            <div class="header-right">
                <!-- View Toggle -->
                <div class="view-toggle">
                    <button class="view-toggle-btn active" data-view="list">List</button>
                    <button class="view-toggle-btn" data-view="explorer">Explorer</button>
                </div>
                <a href="/manage" class="nav-link">Manage</a>
            </div>
        </div>
        <div class="search-controls">
            <div class="search-input-wrapper">
                <input type="text" id="query-input" class="search-input" placeholder="Search your vault..." autocomplete="off">
            </div>
            <select id="vault-select" class="vault-select">
                <option value="">Loading vaults...</option>
            </select>
            <select id="profile-select" class="profile-select">
                <option value="">default</option>
            </select>
            <button id="run-btn" class="run-btn">Run</button>
        </div>
        <div class="search-history-bar">
            <div class="history-items" id="history-items"></div>
            <button class="clear-history-btn-inline" id="clear-history-btn" title="Clear history">‚úï</button>
        </div>
    </header>

    <!-- LIST VIEW -->
    <div class="list-view-container active">
        <div class="list-main">
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <div class="empty-state-text">
                    Enter a query and click Run<br>to see results
                </div>
            </div>
        </div>
    </div>

    <!-- EXPLORER VIEW -->
    <div class="explorer-view-container">
        <div class="explorer-grid">
            <!-- Controls Pane -->
            <div id="controls-pane" class="pane">
                <div class="pane-header">Controls</div>
                <div class="pane-content">
                    <!-- Fetch params (server round-trip required) -->
                    <div class="mixer-section server-section" id="fetch-section">
                        <h3>
                            Fetch
                            <span class="tooltip-wrapper">
                                <span class="info-icon">?</span>
                                <span class="tooltip">Controls WHICH documents are retrieved. Changes require clicking Run.</span>
                            </span>
                        </h3>

                        <!-- Hybrid balance slider -->
                        <div class="balance-slider" style="margin-bottom: 10px;">
                            <div class="balance-labels">
                                <span>
                                    Sem
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>Fetch mode: Semantic</strong><br>Retrieves docs by conceptual similarity.<br>Good for exploratory searches.</span>
                                    </span>
                                </span>
                                <span class="balance-value" id="fetch-balance-value">50/50</span>
                                <span>
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>Fetch mode: Keyword</strong><br>Retrieves docs with exact word matches.<br>Good for specific terms, tags, names.</span>
                                    </span>
                                    BM25
                                </span>
                            </div>
                            <div class="balance-track">
                                <input type="range" id="fetch-hybrid" class="balance-input" min="0" max="100" value="50">
                            </div>
                        </div>

                        <div class="mixer-grid">
                            <div class="mixer-item">
                                <label>
                                    Result Limit
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Maximum number of results to return.</span>
                                    </span>
                                </label>
                                <input type="number" id="fetch-limit" value="20" step="5" min="5" max="100">
                            </div>
                        </div>

                        <div class="checkbox-grid" style="margin-top: 10px;">
                            <div class="checkbox-item">
                                <input type="checkbox" id="fetch-rerank" checked>
                                <label for="fetch-rerank">
                                    Cross-encoder
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>Re-ranks with ms-marco model</strong><br>Processes query + document together for better precision.<br><br>20-30% improvement in top-5 accuracy.<br>Adds ~200ms latency.<br><br><em>Skipped for tag-boosted results.</em></span>
                                    </span>
                                </label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="fetch-expand">
                                <label for="fetch-expand">
                                    Expand query
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>Adds related terms (TF-IDF)</strong><br>For queries &lt;3 words, extracts important terms from top results.<br><br>Helps disambiguate short queries.<br>Adds ~400ms latency.<br><br><em>Not recommended for person names.</em></span>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="refetch-notice">
                            Fetch parameters changed. Click "Run" to apply.
                        </div>
                    </div>

                    <!-- Live params (client-side, instant) -->
                    <div class="mixer-section" id="live-section">
                        <h3>
                            Live
                            <span class="tooltip-wrapper">
                                <span class="info-icon">?</span>
                                <span class="tooltip">Re-rank retrieved results instantly. No server call needed.</span>
                            </span>
                        </h3>

                        <!-- Semantic/BM25 balance slider -->
                        <div class="balance-slider" style="margin-bottom: 10px;">
                            <div class="balance-labels">
                                <span>
                                    Sem
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>Semantic (AI embeddings)</strong><br>0% = Pure conceptual matching<br>Finds "related topics" even with different words.</span>
                                    </span>
                                </span>
                                <span class="balance-value" id="live-balance-value">50/50</span>
                                <span>
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>BM25 (keyword matching)</strong><br>100% = Pure exact matching<br>Finds documents with your exact words (includes tag boosting).</span>
                                    </span>
                                    BM25
                                </span>
                            </div>
                            <div class="balance-track">
                                <input type="range" id="live-balance" class="balance-input" min="0" max="100" value="50">
                            </div>
                        </div>

                        <div class="mixer-grid">
                            <div class="mixer-item">
                                <label>
                                    Tag Multiplier
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>Amplifies tag-boosted results</strong><br>When a document's tags match your query, its Final score is multiplied by this.<br><br><strong>1.0:</strong> No extra boost<br><strong>5.0:</strong> 5x stronger (default)<br><strong>10.0:</strong> Maximum boost<br><br><em>Watch the ‚ö° Yes indicator!</em></span>
                                    </span>
                                </label>
                                <input type="number" id="live-tags" value="5.0" step="0.5" min="1" max="10">
                            </div>

                            <div class="mixer-item">
                                <label>
                                    Time Weight
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip"><strong>Boosts recent documents</strong><br>Recent docs get: Final √ó (1 + Time Weight √ó recency)<br><br><strong>0.0:</strong> No time boost<br><strong>1.0:</strong> Standard boost (default)<br><strong>2.0:</strong> Double the boost<br><br>Recency decays with 90-day half-life.</span>
                                    </span>
                                </label>
                                <input type="number" id="live-time" value="1.0" step="0.1" min="0" max="2">
                            </div>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="action-row">
                        <button id="reset-mix-btn" class="action-btn">Reset Mix</button>
                        <button id="save-profile-btn" class="action-btn">Save Profile...</button>
                        <button id="export-btn" class="action-btn">Export JSON</button>
                    </div>
                </div>
            </div>

            <!-- Results Pane -->
            <div id="results-pane" class="pane">
                <div class="pane-header">
                    Results
                    <span id="result-count" style="color: #666666; font-weight: normal; text-transform: none; margin-left: 8px;"></span>
                </div>
                <div class="pane-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">
                            Enter a query and click Run<br>to see results
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inspector Pane -->
            <div id="inspector-pane" class="pane">
                <div class="pane-header">
                    Inspector
                    <button id="help-btn" class="help-btn" title="Show scoring help">?</button>
                </div>
                <div class="pane-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">
                            Select a result<br>to inspect details
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // State Management
        // ========================================

        const STORAGE_VERSION = 3;
        const STORAGE_KEY = `temoa_v${STORAGE_VERSION}_state`;

        const state = {
            // Search state
            query: '',
            vault: null,
            profile: null,
            vaults: [],
            profiles: [],

            // Results
            rawResults: [],
            remixedResults: [],
            pipelineData: null,

            // UI state
            viewMode: 'list',  // 'list' | 'explorer'
            selectedResult: null,
            searchHistory: [],

            // Fetch params (require server round-trip)
            fetchParams: {
                hybrid_weight: 0.5,
                limit: 20,
                rerank: true,
                expand: false
            },

            // Live params (client-side remix)
            liveParams: {
                mix_balance: 0.5,
                tag_multiplier: 5.0,
                time_weight: 1.0
            },

            fetchParamsChanged: false,
            lastFetchParams: null
        };

        // ========================================
        // Help Panel
        // ========================================

        function showHelpPanel() {
            const inspectorContent = document.querySelector('#inspector-pane .pane-content');

            const helpPanel = document.createElement('div');
            helpPanel.className = 'help-panel';
            helpPanel.innerHTML = `
                <h2>Understanding Temoa Scores</h2>

                <h3>üìä Score Types</h3>
                <p><strong>Semantic (0.0-1.0)</strong>: Conceptual similarity using AI embeddings. Finds documents about the same topic even with different words.</p>
                <div class="score-example">
                    0.0-0.3 = Not relevant<br>
                    0.3-0.5 = Somewhat related<br>
                    0.5-0.7 = Relevant<br>
                    0.7-1.0 = Highly relevant
                </div>

                <p><strong>BM25 (0-30+)</strong>: Keyword matching score. Higher = more exact word matches. Tags get 2x weight + 5x boost when matched.</p>
                <div class="score-example">
                    0-5 = Weak match<br>
                    5-15 = Good match<br>
                    15+ = Excellent match (often tag-boosted)
                </div>

                <p><strong>RRF (0.0-0.05+)</strong>: Reciprocal Rank Fusion. Combines Semantic + BM25 rankings. Tag-boosted docs get 1.5-2.0x multiplier.</p>
                <div class="score-example">
                    Formula: sum(1 / (60 + rank))<br>
                    ‚Ä¢ Docs in both lists = highest<br>
                    ‚Ä¢ Tag matches = 1.5-2.0x boost<br>
                    ‚Ä¢ BM25-only = conservative boost
                </div>

                <p><strong>Cross-Enc (-12 to +12)</strong>: Precision re-ranking using ms-marco model. Processes query + document together.</p>
                <div class="score-example">
                    Negative = Not relevant<br>
                    -1 to 0 = Weak match<br>
                    0 to +2 = Good match<br>
                    +2 to +12 = Excellent match
                </div>

                <p><strong>Final (0.0-2.0+)</strong>: Client-side remixed score using LIVE controls.</p>
                <div class="score-example">
                    Formula: (Sem √ó (1-balance) + BM25 √ó balance)<br>
                    ‚Ä¢ Tag-boosted: √ó Tag Multiplier<br>
                    ‚Ä¢ Recent docs: √ó (1 + Time Weight)
                </div>

                <h3>üéõÔ∏è How Controls Affect Results</h3>

                <p><strong>Sem/BM25 Balance (LIVE)</strong>:</p>
                <ul>
                    <li><code>0%</code> = Pure semantic (concept matching)</li>
                    <li><code>50%</code> = Balanced (default)</li>
                    <li><code>100%</code> = Pure BM25 (exact keywords + tags)</li>
                </ul>

                <p><strong>Tag Multiplier (LIVE)</strong>: When a document's tags match your query, its Final score is multiplied by this value. Look for the ‚ö° Yes indicator!</p>

                <p><strong>Time Weight (LIVE)</strong>: Recent documents get boosted. Uses 90-day half-life exponential decay. Higher weight = stronger boost for recent docs.</p>

                <h3>üîç Search Pipeline</h3>
                <p>Temoa uses a 7-stage pipeline:</p>
                <ul>
                    <li><strong>Stage 0:</strong> Query Expansion (optional, for short queries)</li>
                    <li><strong>Stage 1:</strong> Primary Retrieval (Semantic + BM25 hybrid)</li>
                    <li><strong>Stage 2:</strong> Chunk Deduplication (best chunk per file)</li>
                    <li><strong>Stage 3:</strong> Score Filtering (min threshold)</li>
                    <li><strong>Stage 4:</strong> Status Filtering (remove inactive)</li>
                    <li><strong>Stage 5:</strong> Type Filtering (include/exclude types)</li>
                    <li><strong>Stage 6:</strong> Cross-Encoder Re-ranking (precision boost)</li>
                </ul>

                <h3>‚ö° Tag Boosting</h3>
                <p>When your query matches document tags:</p>
                <ul>
                    <li>BM25 score gets 5x multiplier</li>
                    <li>RRF fusion gets 1.5-2.0x aggressive boost</li>
                    <li>Cross-encoder re-ranking is skipped (already perfect)</li>
                    <li>Result marked with ‚ö° Yes indicator</li>
                </ul>

                <p style="margin-top: 20px; padding-top: 12px; border-top: 1px solid #333; font-size: 11px; color: #888;">
                    <em>Hover over any score label or control to see detailed tooltips!</em>
                </p>
            `;

            inspectorContent.replaceChildren(helpPanel);
        }

        // ========================================
        // Initialization
        // ========================================

        async function initialize() {
            restoreState();
            await loadVaults();
            await loadProfiles();
            syncUIWithState();
            setupEventHandlers();
            console.log('Temoa initialized', state);
        }

        function restoreState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.viewMode) state.viewMode = data.viewMode;
                    if (data.searchHistory) state.searchHistory = data.searchHistory;
                    if (data.fetchParams) state.fetchParams = { ...state.fetchParams, ...data.fetchParams };
                    if (data.liveParams) state.liveParams = { ...state.liveParams, ...data.liveParams };
                    if (data.vault) state.vault = data.vault;
                    if (data.profile) state.profile = data.profile;
                }
            } catch (err) {
                console.error('Failed to restore state:', err);
            }
        }

        function saveState() {
            try {
                const data = {
                    viewMode: state.viewMode,
                    searchHistory: state.searchHistory,
                    fetchParams: state.fetchParams,
                    liveParams: state.liveParams,
                    vault: state.vault,
                    profile: state.profile
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (err) {
                console.error('Failed to save state:', err);
            }
        }

        function syncUIWithState() {
            // Set view mode
            switchView(state.viewMode, false);

            // Render search history
            renderSearchHistory();

            // Sync explorer controls if in explorer mode
            syncExplorerControls();
        }

        function syncExplorerControls() {
            const fetchHybrid = document.getElementById('fetch-hybrid');
            const fetchBalanceValue = document.getElementById('fetch-balance-value');
            const fetchLimit = document.getElementById('fetch-limit');
            const fetchRerank = document.getElementById('fetch-rerank');
            const fetchExpand = document.getElementById('fetch-expand');

            const liveBalance = document.getElementById('live-balance');
            const liveBalanceValue = document.getElementById('live-balance-value');
            const liveTags = document.getElementById('live-tags');
            const liveTime = document.getElementById('live-time');

            if (!fetchHybrid) return; // Controls not loaded yet

            // Fetch controls
            const fetchWeight = Math.round(state.fetchParams.hybrid_weight * 100);
            fetchHybrid.value = fetchWeight;
            fetchBalanceValue.textContent = `${100-fetchWeight}/${fetchWeight}`;
            fetchLimit.value = state.fetchParams.limit;
            fetchRerank.checked = state.fetchParams.rerank;
            fetchExpand.checked = state.fetchParams.expand;

            // Live controls
            const liveWeight = Math.round(state.liveParams.mix_balance * 100);
            liveBalance.value = liveWeight;
            liveBalanceValue.textContent = `${100-liveWeight}/${liveWeight}`;
            liveTags.value = state.liveParams.tag_multiplier;
            liveTime.value = state.liveParams.time_weight;
        }

        async function loadVaults() {
            try {
                const res = await fetch('/vaults');
                const data = await res.json();
                state.vaults = data.vaults || [];

                const vaultSelect = document.getElementById('vault-select');
                vaultSelect.innerHTML = state.vaults.map(v =>
                    `<option value="${v.name}" ${v.is_default ? 'selected' : ''}>${v.name}${v.is_default ? ' (default)' : ''}</option>`
                ).join('');

                const defaultVault = state.vaults.find(v => v.is_default);
                state.vault = state.vault || defaultVault?.name || state.vaults[0]?.name;
            } catch (err) {
                console.error('Failed to load vaults:', err);
            }
        }

        async function loadProfiles() {
            try {
                const res = await fetch('/profiles');
                const data = await res.json();
                state.profiles = data.profiles || [];

                const profileSelect = document.getElementById('profile-select');
                profileSelect.innerHTML = '<option value="">default</option>' +
                    state.profiles.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            } catch (err) {
                console.error('Failed to load profiles:', err);
            }
        }

        // ========================================
        // Event Handlers
        // ========================================

        function setupEventHandlers() {
            // View toggle
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    switchView(view, true);
                });
            });

            // Search
            document.getElementById('run-btn').addEventListener('click', runSearch);
            document.getElementById('query-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') runSearch();
            });

            // Vault/profile selectors
            document.getElementById('vault-select').addEventListener('change', (e) => {
                state.vault = e.target.value;
                saveState();
            });

            document.getElementById('profile-select').addEventListener('change', (e) => {
                state.profile = e.target.value || null;
                saveState();
            });

            // History
            document.getElementById('clear-history-btn').addEventListener('click', clearSearchHistory);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && e.target.tagName !== 'INPUT') {
                    e.preventDefault();
                    document.getElementById('query-input').focus();
                }
                if (e.key === 'Escape') {
                    document.getElementById('query-input').blur();
                }
                if (e.key === 't' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT') {
                    e.preventDefault();
                    toggleView();
                }
            });

            // Help button
            const helpBtn = document.getElementById('help-btn');
            if (helpBtn) {
                helpBtn.addEventListener('click', showHelpPanel);
            }

            // Explorer controls setup (only if elements exist)
            setupExplorerControls();

            // Mobile accordion for explorer
            setupMobileAccordion();
        }

        function setupExplorerControls() {
            const fetchHybrid = document.getElementById('fetch-hybrid');
            const fetchBalanceValue = document.getElementById('fetch-balance-value');
            const fetchLimit = document.getElementById('fetch-limit');
            const fetchRerank = document.getElementById('fetch-rerank');
            const fetchExpand = document.getElementById('fetch-expand');
            const fetchSection = document.getElementById('fetch-section');

            const liveBalance = document.getElementById('live-balance');
            const liveBalanceValue = document.getElementById('live-balance-value');
            const liveTags = document.getElementById('live-tags');
            const liveTime = document.getElementById('live-time');

            const resetMixBtn = document.getElementById('reset-mix-btn');
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const exportBtn = document.getElementById('export-btn');

            if (!fetchHybrid) return; // Elements not loaded yet

            // Fetch controls (mark as dirty when changed)
            fetchHybrid.addEventListener('input', () => {
                const val = parseInt(fetchHybrid.value);
                fetchBalanceValue.textContent = `${100-val}/${val}`;
                state.fetchParams.hybrid_weight = val / 100;
                markFetchDirty();
                saveState();
            });

            fetchLimit.addEventListener('change', () => {
                state.fetchParams.limit = parseInt(fetchLimit.value);
                markFetchDirty();
                saveState();
            });

            fetchRerank.addEventListener('change', () => {
                state.fetchParams.rerank = fetchRerank.checked;
                markFetchDirty();
                saveState();
            });

            fetchExpand.addEventListener('change', () => {
                state.fetchParams.expand = fetchExpand.checked;
                markFetchDirty();
                saveState();
            });

            // Live controls (instant remix when results exist)
            liveBalance.addEventListener('input', () => {
                const val = parseInt(liveBalance.value);
                liveBalanceValue.textContent = `${100-val}/${val}`;
                state.liveParams.mix_balance = val / 100;
                if (state.rawResults.length > 0) {
                    remixAndRender();
                }
                saveState();
            });

            liveTags.addEventListener('change', () => {
                state.liveParams.tag_multiplier = parseFloat(liveTags.value);
                if (state.rawResults.length > 0) {
                    remixAndRender();
                }
                saveState();
            });

            liveTime.addEventListener('change', () => {
                state.liveParams.time_weight = parseFloat(liveTime.value);
                if (state.rawResults.length > 0) {
                    remixAndRender();
                }
                saveState();
            });

            // Action buttons
            resetMixBtn.addEventListener('click', resetMix);
            saveProfileBtn.addEventListener('click', () => {
                alert('Profile saving not yet implemented');
            });
            exportBtn.addEventListener('click', () => {
                if (state.rawResults.length === 0) {
                    alert('No results to export');
                    return;
                }
                const dataStr = JSON.stringify(state.remixedResults || state.rawResults, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `temoa-results-${Date.now()}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });
        }

        function markFetchDirty() {
            const fetchSection = document.getElementById('fetch-section');
            if (!fetchSection) return;

            if (state.lastFetchParams) {
                const current = state.fetchParams;
                const last = state.lastFetchParams;
                const changed =
                    current.hybrid_weight !== last.hybrid_weight ||
                    current.limit !== last.limit ||
                    current.rerank !== last.rerank ||
                    current.expand !== last.expand;

                if (changed) {
                    fetchSection.classList.add('dirty');
                    state.fetchParamsChanged = true;
                } else {
                    fetchSection.classList.remove('dirty');
                    state.fetchParamsChanged = false;
                }
            }
        }

        function resetMix() {
            // Reset to defaults
            state.liveParams = {
                mix_balance: 0.5,
                tag_multiplier: 5.0,
                time_weight: 1.0
            };

            // Update UI
            const liveBalance = document.getElementById('live-balance');
            const liveBalanceValue = document.getElementById('live-balance-value');
            const liveTags = document.getElementById('live-tags');
            const liveTime = document.getElementById('live-time');

            if (liveBalance) {
                liveBalance.value = 50;
                liveBalanceValue.textContent = '50/50';
                liveTags.value = 5.0;
                liveTime.value = 1.0;
            }

            // Remix if results exist
            if (state.rawResults.length > 0) {
                remixAndRender();
            }

            saveState();
        }

        function setupMobileAccordion() {
            const controlsPane = document.getElementById('controls-pane');
            if (!controlsPane) return;

            if (window.innerWidth <= 768) {
                const controlsHeader = controlsPane.querySelector('.pane-header');
                if (controlsHeader) {
                    controlsHeader.addEventListener('click', () => {
                        controlsPane.classList.toggle('expanded');
                    });
                }
            }
        }

        // ========================================
        // View Switching
        // ========================================

        function switchView(view, save = true) {
            state.viewMode = view;

            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Show/hide containers
            document.querySelector('.list-view-container').classList.toggle('active', view === 'list');
            document.querySelector('.explorer-view-container').classList.toggle('active', view === 'explorer');

            // Re-render results for the new view if we have results
            if (state.rawResults.length > 0) {
                if (view === 'explorer') {
                    renderExplorerResults();
                } else {
                    renderListResults();
                }
            }

            if (save) {
                saveState();
            }
        }

        function toggleView() {
            const newView = state.viewMode === 'list' ? 'explorer' : 'list';
            switchView(newView, true);
        }

        // ========================================
        // Search Flow
        // ========================================

        async function runSearch() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) return;

            const mainEl = state.viewMode === 'list'
                ? document.querySelector('.list-main')
                : document.querySelector('#results-pane .pane-content');

            mainEl.innerHTML = '<div class="loading"><div class="spinner"></div><span>Searching...</span></div>';

            const runBtn = document.getElementById('run-btn');
            runBtn.disabled = true;

            try {
                const params = new URLSearchParams({
                    q: query,
                    vault: state.vault || '',
                    limit: state.fetchParams.limit,
                    hybrid_weight: state.fetchParams.hybrid_weight,
                    rerank: state.fetchParams.rerank,
                    expand: state.fetchParams.expand,
                    harness: 'true'
                });

                if (state.profile) params.set('profile', state.profile);

                const response = await fetch(`/search?${params}`);
                if (!response.ok) throw new Error(`Search failed: ${response.statusText}`);

                const data = await response.json();
                state.rawResults = data.results || [];
                state.pipelineData = data.pipeline_stages || null;
                state.query = query;

                // Mark fetch params as clean
                state.lastFetchParams = { ...state.fetchParams };
                const fetchSection = document.getElementById('fetch-section');
                if (fetchSection) {
                    fetchSection.classList.remove('dirty');
                }
                state.fetchParamsChanged = false;

                addToSearchHistory(query);
                remixAndRender();

            } catch (err) {
                console.error('Search error:', err);
                mainEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Search failed<br>${err.message}</div>
                    </div>
                `;
            } finally {
                runBtn.disabled = false;
            }
        }

        function remixAndRender() {
            // Client-side remix: re-blend semantic/BM25, apply tag/time multipliers
            if (!state.rawResults || state.rawResults.length === 0) return;

            const { mix_balance, tag_multiplier, time_weight } = state.liveParams;

            // Clone and re-score
            const remixed = state.rawResults.map(r => {
                const clone = { ...r };

                // Re-blend semantic + BM25 scores
                const semanticScore = clone.similarity_score || 0;
                const bm25Score = clone.bm25_score || 0;

                // Normalize BM25 to 0-1 range (assuming max ~10)
                const normalizedBM25 = Math.min(bm25Score / 10, 1);

                // Mix: 0 = all semantic, 1 = all BM25
                let mixedScore = (1 - mix_balance) * semanticScore + mix_balance * normalizedBM25;

                // Apply tag multiplier if tag boosted
                if (clone.tag_boosted) {
                    mixedScore *= tag_multiplier;
                }

                // Apply time boost
                if (clone.time_boost && time_weight > 0) {
                    mixedScore *= (1 + clone.time_boost * time_weight);
                }

                clone.final_score = mixedScore;
                return clone;
            });

            // Sort by final score descending
            remixed.sort((a, b) => b.final_score - a.final_score);

            state.remixedResults = remixed;

            if (state.viewMode === 'list') {
                renderListResults();
            } else {
                renderExplorerResults();
            }
        }

        function renderListResults() {
            const mainEl = document.querySelector('.list-main');

            const results = state.remixedResults.length > 0 ? state.remixedResults : state.rawResults;

            if (!results || results.length === 0) {
                mainEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No results found</div>
                    </div>
                `;
                return;
            }

            // Create results table
            const table = document.createElement('div');
            table.className = 'results-table';

            results.forEach(result => {
                const card = createListResultCard(result);
                table.appendChild(card);
            });

            mainEl.replaceChildren(table);
        }

        function createListResultCard(result) {
            const card = document.createElement('div');
            card.className = 'result-row';

            // Title row with badges
            const titleRow = document.createElement('div');
            titleRow.style.display = 'flex';
            titleRow.style.justifyContent = 'space-between';
            titleRow.style.alignItems = 'flex-start';
            titleRow.style.gap = '8px';
            titleRow.style.marginBottom = '4px';

            const titleLink = document.createElement('a');
            titleLink.className = 'result-title-link';
            titleLink.href = result.obsidian_uri;
            titleLink.textContent = result.title || result.relative_path;
            titleRow.appendChild(titleLink);

            // Badges
            const badgesDiv = document.createElement('div');
            badgesDiv.style.display = 'flex';
            badgesDiv.style.gap = '4px';
            badgesDiv.style.flexShrink = '0';

            if (result.frontmatter?.type) {
                const type = Array.isArray(result.frontmatter.type)
                    ? result.frontmatter.type.join(', ')
                    : String(result.frontmatter.type);
                const badge = document.createElement('span');
                badge.className = 'type-badge';
                badge.textContent = type;
                badgesDiv.appendChild(badge);
            }

            if (result.frontmatter?.project) {
                const vaultName = result.obsidian_uri.split('/')[3];
                let project = result.frontmatter.project;
                if (Array.isArray(project)) project = project[0];
                const projectName = String(project).replace(/[\[\]]/g, '');
                const projectUri = `obsidian://vault/${vaultName}/${encodeURIComponent(projectName)}`;
                const badge = document.createElement('a');
                badge.className = 'project-badge';
                badge.textContent = projectName;
                badge.href = projectUri;
                badgesDiv.appendChild(badge);
            }

            if (badgesDiv.children.length > 0) {
                titleRow.appendChild(badgesDiv);
            }

            card.appendChild(titleRow);

            // Path
            const pathDiv = document.createElement('div');
            pathDiv.className = 'result-path';
            pathDiv.textContent = result.relative_path;
            card.appendChild(pathDiv);

            // Dates
            if (result.frontmatter?.created || result.frontmatter?.modified) {
                const datesDiv = document.createElement('div');
                datesDiv.className = 'result-dates';
                const dateParts = [];
                if (result.frontmatter.created) {
                    dateParts.push(`Created: ${formatDate(result.frontmatter.created)}`);
                }
                if (result.frontmatter.modified) {
                    dateParts.push(`Modified: ${formatDate(result.frontmatter.modified)}`);
                }
                datesDiv.textContent = dateParts.join('  ‚Ä¢  ');
                card.appendChild(datesDiv);
            }

            // Description
            if (result.description) {
                const desc = document.createElement('div');
                desc.className = 'result-description';
                desc.textContent = result.description;
                card.appendChild(desc);
            }

            // Tags
            if (result.tags && result.tags.length > 0) {
                const tagsDiv = document.createElement('div');
                tagsDiv.className = 'result-tags';
                result.tags.slice(0, 5).forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag';
                    tagSpan.textContent = `#${tag}`;
                    tagsDiv.appendChild(tagSpan);
                });
                if (result.tags.length > 5) {
                    const more = document.createElement('span');
                    more.className = 'tag';
                    more.textContent = `+${result.tags.length - 5} more`;
                    tagsDiv.appendChild(more);
                }
                card.appendChild(tagsDiv);
            }

            return card;
        }

        function renderExplorerResults() {
            const resultsEl = document.querySelector('#results-pane .pane-content');
            const resultCount = document.getElementById('result-count');

            const results = state.remixedResults.length > 0 ? state.remixedResults : state.rawResults;

            if (!results || results.length === 0) {
                resultsEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No results found</div>
                    </div>
                `;
                if (resultCount) resultCount.textContent = '';
                return;
            }

            // Update result count
            if (resultCount) resultCount.textContent = `(${results.length})`;

            // Create results table
            const table = document.createElement('div');
            table.className = 'results-table';

            results.forEach(result => {
                const card = createExplorerResultCard(result);
                table.appendChild(card);
            });

            resultsEl.replaceChildren(table);
        }

        function createExplorerResultCard(result) {
            const card = document.createElement('div');
            card.className = 'result-row';
            card.dataset.resultId = result.relative_path;

            // Click handler for inspector
            card.addEventListener('click', () => {
                selectResult(result);
            });

            // Title row with badges
            const titleRow = document.createElement('div');
            titleRow.style.display = 'flex';
            titleRow.style.justifyContent = 'space-between';
            titleRow.style.alignItems = 'flex-start';
            titleRow.style.gap = '8px';
            titleRow.style.marginBottom = '4px';

            const titleLink = document.createElement('a');
            titleLink.className = 'result-title-link';
            titleLink.href = result.obsidian_uri;
            titleLink.textContent = result.title || result.relative_path;
            titleLink.addEventListener('click', (e) => {
                e.stopPropagation();  // Don't trigger card click
            });
            titleRow.appendChild(titleLink);

            // Badges
            const badgesDiv = document.createElement('div');
            badgesDiv.style.display = 'flex';
            badgesDiv.style.gap = '4px';
            badgesDiv.style.flexShrink = '0';

            if (result.frontmatter?.type) {
                const type = Array.isArray(result.frontmatter.type)
                    ? result.frontmatter.type.join(', ')
                    : String(result.frontmatter.type);
                const badge = document.createElement('span');
                badge.className = 'type-badge';
                badge.textContent = type;
                badgesDiv.appendChild(badge);
            }

            if (result.frontmatter?.project) {
                const vaultName = result.obsidian_uri.split('/')[3];
                let project = result.frontmatter.project;
                if (Array.isArray(project)) project = project[0];
                const projectName = String(project).replace(/[\[\]]/g, '');
                const projectUri = `obsidian://vault/${vaultName}/${encodeURIComponent(projectName)}`;
                const badge = document.createElement('a');
                badge.className = 'project-badge';
                badge.textContent = projectName;
                badge.href = projectUri;
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                badgesDiv.appendChild(badge);
            }

            if (badgesDiv.children.length > 0) {
                titleRow.appendChild(badgesDiv);
            }

            card.appendChild(titleRow);

            // Path
            const pathDiv = document.createElement('div');
            pathDiv.className = 'result-path';
            pathDiv.textContent = result.relative_path;
            card.appendChild(pathDiv);

            // Dates
            if (result.frontmatter?.created || result.frontmatter?.modified) {
                const datesDiv = document.createElement('div');
                datesDiv.className = 'result-dates';
                const dateParts = [];
                if (result.frontmatter.created) {
                    dateParts.push(`Created: ${formatDate(result.frontmatter.created)}`);
                }
                if (result.frontmatter.modified) {
                    dateParts.push(`Modified: ${formatDate(result.frontmatter.modified)}`);
                }
                datesDiv.textContent = dateParts.join('  ‚Ä¢  ');
                card.appendChild(datesDiv);
            }

            // Description
            if (result.description) {
                const desc = document.createElement('div');
                desc.className = 'result-description';
                desc.textContent = result.description;
                card.appendChild(desc);
            }

            // Tags
            if (result.tags && result.tags.length > 0) {
                const tagsDiv = document.createElement('div');
                tagsDiv.className = 'result-tags';
                result.tags.slice(0, 5).forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag';
                    tagSpan.textContent = `#${tag}`;
                    tagsDiv.appendChild(tagSpan);
                });
                if (result.tags.length > 5) {
                    const more = document.createElement('span');
                    more.className = 'tag';
                    more.textContent = `+${result.tags.length - 5} more`;
                    tagsDiv.appendChild(more);
                }
                card.appendChild(tagsDiv);
            }

            // Scores
            const scoresDiv = document.createElement('div');
            scoresDiv.className = 'result-scores-compact';
            const scoreParts = [];

            if (result.similarity_score !== undefined) {
                scoreParts.push(`${(result.similarity_score * 100).toFixed(1)}% sem`);
            }
            if (result.bm25_score !== undefined) {
                scoreParts.push(`${result.bm25_score.toFixed(1)} bm25`);
            }
            if (result.rrf_score !== undefined) {
                scoreParts.push(`${result.rrf_score.toFixed(4)} rrf`);
            }
            if (result.cross_encoder_score !== undefined) {
                scoreParts.push(`${result.cross_encoder_score.toFixed(3)} xe`);
            }
            if (result.tag_boosted) {
                scoreParts.push('tag‚ö°');
            }
            if (result.time_boost !== undefined && result.time_boost > 0) {
                scoreParts.push(`time+${(result.time_boost * 100).toFixed(0)}%`);
            }
            if (result.final_score !== undefined) {
                scoreParts.push(`final=${result.final_score.toFixed(3)}`);
            }

            scoresDiv.textContent = scoreParts.join(' | ');
            card.appendChild(scoresDiv);

            return card;
        }

        // ========================================
        // Search History
        // ========================================

        function addToSearchHistory(query) {
            const trimmed = query.trim();
            if (!trimmed) return;

            state.searchHistory = state.searchHistory.filter(q => q !== trimmed);
            state.searchHistory.unshift(trimmed);

            if (state.searchHistory.length > 10) {
                state.searchHistory = state.searchHistory.slice(0, 10);
            }

            saveState();
            renderSearchHistory();
        }

        function renderSearchHistory() {
            const historyItems = document.getElementById('history-items');

            if (state.searchHistory.length === 0) {
                historyItems.innerHTML = '<span style="color: #666; font-size: 11px;">No recent searches</span>';
                return;
            }

            historyItems.innerHTML = state.searchHistory.map(query => `
                <div class="history-chip" data-query="${escapeHtml(query)}">${escapeHtml(query)}</div>
            `).join('');

            // Add click handlers
            historyItems.querySelectorAll('.history-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const query = chip.dataset.query;
                    document.getElementById('query-input').value = query;
                    runSearch();
                });
            });
        }

        function clearSearchHistory() {
            if (!confirm('Clear all search history?')) return;
            state.searchHistory = [];
            saveState();
            renderSearchHistory();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // Explorer Inspector Functions
        // ========================================

        function selectResult(result) {
            // Update selected state
            state.selectedResult = result;

            // Visual feedback
            const cards = document.querySelectorAll('.result-row');
            cards.forEach(c => c.classList.remove('selected'));
            const selectedCard = document.querySelector(`[data-result-id="${result.relative_path}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Update inspector
            renderInspector(result);

            // Mobile: show inspector drawer
            if (window.innerWidth <= 768) {
                const inspectorPane = document.getElementById('inspector-pane');
                if (inspectorPane) {
                    inspectorPane.classList.add('visible');
                }
            }
        }

        function renderInspector(result) {
            const inspectorContent = document.querySelector('#inspector-pane .pane-content');
            if (!inspectorContent) return;

            const container = document.createElement('div');
            container.style.position = 'relative';

            // Close button (mobile only)
            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-inspector';
            closeBtn.innerHTML = '√ó';
            closeBtn.addEventListener('click', () => {
                const inspectorPane = document.getElementById('inspector-pane');
                if (inspectorPane) {
                    inspectorPane.classList.remove('visible');
                }
                const cards = document.querySelectorAll('.result-row');
                cards.forEach(c => c.classList.remove('selected'));
                state.selectedResult = null;
            });
            container.appendChild(closeBtn);

            // Title section
            const titleSection = document.createElement('div');
            titleSection.className = 'inspector-section';

            const title = document.createElement('div');
            title.className = 'inspector-title';
            title.textContent = result.title || result.relative_path;
            titleSection.appendChild(title);

            const path = document.createElement('div');
            path.className = 'inspector-path';
            path.textContent = result.relative_path;
            titleSection.appendChild(path);

            const link = document.createElement('a');
            link.className = 'inspector-link';
            link.href = result.obsidian_uri;
            link.textContent = '‚Üó Open in Obsidian';
            titleSection.appendChild(link);

            container.appendChild(titleSection);

            // Scores section
            const scoresSection = document.createElement('div');
            scoresSection.className = 'inspector-section';

            const scoresTitle = document.createElement('h3');
            scoresTitle.textContent = 'Scores';
            scoresSection.appendChild(scoresTitle);

            // Semantic score
            if (result.similarity_score !== undefined) {
                scoresSection.appendChild(createScoreBar(
                    'Semantic',
                    result.similarity_score,
                    result.similarity_score,
                    '<strong>Scale: 0.0 to 1.0</strong><br>' +
                    'Measures conceptual similarity using AI embeddings. ' +
                    'Finds documents about the same topic even if they use different words.<br><br>' +
                    '<strong>0.0-0.3:</strong> Not relevant<br>' +
                    '<strong>0.3-0.5:</strong> Somewhat related<br>' +
                    '<strong>0.5-0.7:</strong> Relevant<br>' +
                    '<strong>0.7-1.0:</strong> Highly relevant'
                ));
            }

            // BM25 score (normalize to 0-1 for visual, assuming max ~10)
            if (result.bm25_score !== undefined) {
                const normalizedBM25 = Math.min(result.bm25_score / 10, 1);
                scoresSection.appendChild(createScoreBar(
                    'BM25',
                    result.bm25_score.toFixed(2),
                    normalizedBM25,
                    '<strong>Scale: 0 to 30+ (typical: 0-15)</strong><br>' +
                    'Keyword matching score. Higher = more exact word matches.<br><br>' +
                    '<strong>Factors:</strong><br>' +
                    '‚Ä¢ How often query words appear<br>' +
                    '‚Ä¢ How rare the words are (rare = higher)<br>' +
                    '‚Ä¢ Document length (longer = lower)<br>' +
                    '‚Ä¢ Tags get 2x weight + 5x boost when matched<br><br>' +
                    '<strong>0-5:</strong> Weak match<br>' +
                    '<strong>5-15:</strong> Good match<br>' +
                    '<strong>15+:</strong> Excellent match (often tag-boosted)'
                ));
            }

            // RRF score
            if (result.rrf_score !== undefined) {
                scoresSection.appendChild(createScoreBar(
                    'RRF',
                    result.rrf_score.toFixed(4),
                    result.rrf_score,
                    '<strong>Scale: 0.0 to ~0.05 (typical)</strong><br>' +
                    'Reciprocal Rank Fusion - combines Semantic + BM25 rankings.<br><br>' +
                    '<strong>How it works:</strong><br>' +
                    'RRF = sum(1 / (60 + rank))<br>' +
                    '‚Ä¢ Docs in both lists: highest scores<br>' +
                    '‚Ä¢ Tag-boosted docs: 1.5-2.0x multiplier<br>' +
                    '‚Ä¢ BM25-only docs: conservative boost<br><br>' +
                    '<strong>0.00-0.02:</strong> Lower ranked<br>' +
                    '<strong>0.02-0.04:</strong> Mid-tier<br>' +
                    '<strong>0.04+:</strong> Top results'
                ));
            }

            // Cross-encoder score
            if (result.cross_encoder_score !== undefined) {
                // Cross-encoder is typically -1 to 1, normalize to 0-1
                const normalized = (result.cross_encoder_score + 1) / 2;
                scoresSection.appendChild(createScoreBar(
                    'Cross-Enc',
                    result.cross_encoder_score.toFixed(4),
                    normalized,
                    '<strong>Scale: -12 to +12 (typical: -1 to +1)</strong><br>' +
                    'Precision re-ranking using ms-marco-MiniLM model. ' +
                    'Processes query + document together for accurate relevance.<br><br>' +
                    '<strong>Negative:</strong> Not relevant<br>' +
                    '<strong>-1 to 0:</strong> Weak match<br>' +
                    '<strong>0 to +2:</strong> Good match<br>' +
                    '<strong>+2 to +12:</strong> Excellent match<br><br>' +
                    '<em>Note: Skipped for tag-boosted results (already perfect)</em>'
                ));
            }

            // Tag boost indicator
            if (result.tag_boosted) {
                const row = document.createElement('div');
                row.className = 'inspector-row';
                const label = document.createElement('div');
                label.className = 'inspector-label';
                label.textContent = 'Tag Boosted';
                const value = document.createElement('div');
                value.className = 'inspector-value';

                // Show actual multiplier effect
                const currentMultiplier = state.liveParams.tag_multiplier;
                if (currentMultiplier > 1) {
                    value.textContent = `‚ö° Yes (${currentMultiplier}x)`;
                    value.style.color = '#cc8800';
                } else if (currentMultiplier === 1) {
                    value.textContent = '‚ö° Disabled (1x)';
                    value.style.color = '#888888';
                } else {
                    value.textContent = `‚ö° Reduced (${currentMultiplier}x)`;
                    value.style.color = '#666666';
                }

                row.appendChild(label);
                row.appendChild(value);
                scoresSection.appendChild(row);
            }

            // Time boost
            if (result.time_boost !== undefined && result.time_boost > 0) {
                const row = document.createElement('div');
                row.className = 'inspector-row';
                const label = document.createElement('div');
                label.className = 'inspector-label';
                label.textContent = 'Time Boost';
                const value = document.createElement('div');
                value.className = 'inspector-value';
                value.textContent = `+${(result.time_boost * 100).toFixed(0)}%`;
                value.style.color = '#88aa88';
                row.appendChild(label);
                row.appendChild(value);
                scoresSection.appendChild(row);
            }

            // Final score (if remixed)
            if (result.final_score !== undefined) {
                const results = state.remixedResults.length > 0 ? state.remixedResults : state.rawResults;
                const maxFinal = Math.max(...results.map(r => r.final_score || 0));
                const normalized = maxFinal > 0 ? result.final_score / maxFinal : 0;
                scoresSection.appendChild(createScoreBar(
                    'Final',
                    result.final_score.toFixed(4),
                    normalized,
                    '<strong>Scale: 0.0 to 2.0+ (depends on mix)</strong><br>' +
                    'Client-side remixed score using LIVE controls.<br><br>' +
                    '<strong>Formula:</strong><br>' +
                    'Final = (Sem √ó (1-balance) + BM25 √ó balance)<br>' +
                    '‚Ä¢ Tag-boosted: √ó Tag Multiplier<br>' +
                    '‚Ä¢ Recent docs: √ó (1 + Time Weight)<br><br>' +
                    '<em>Adjust sliders in Controls to see this change!</em>'
                ));
            }

            container.appendChild(scoresSection);

            // Metadata section
            if (result.frontmatter && Object.keys(result.frontmatter).length > 0) {
                const metaSection = document.createElement('div');
                metaSection.className = 'inspector-section';

                const metaTitle = document.createElement('h3');
                metaTitle.textContent = 'Metadata';
                metaSection.appendChild(metaTitle);

                // Dates
                if (result.frontmatter.created) {
                    metaSection.appendChild(createInspectorRow('Created', formatDate(result.frontmatter.created)));
                }
                if (result.frontmatter.modified) {
                    metaSection.appendChild(createInspectorRow('Modified', formatDate(result.frontmatter.modified)));
                }

                // Type
                if (result.frontmatter.type) {
                    const typeVal = Array.isArray(result.frontmatter.type)
                        ? result.frontmatter.type.join(', ')
                        : String(result.frontmatter.type);
                    metaSection.appendChild(createInspectorRow('Type', typeVal));
                }

                // Project
                if (result.frontmatter.project) {
                    let projectVal = result.frontmatter.project;
                    if (Array.isArray(projectVal)) projectVal = projectVal.join(', ');
                    metaSection.appendChild(createInspectorRow('Project', String(projectVal)));
                }

                // Status (for gleanings)
                if (result.frontmatter.status) {
                    metaSection.appendChild(createInspectorRow('Status', result.frontmatter.status));
                }

                // Source/URL (for gleanings)
                if (result.frontmatter.source) {
                    metaSection.appendChild(createInspectorRow('Source', result.frontmatter.source));
                }
                if (result.frontmatter.url) {
                    const row = document.createElement('div');
                    row.className = 'inspector-row';
                    const label = document.createElement('div');
                    label.className = 'inspector-label';
                    label.textContent = 'URL';
                    const value = document.createElement('a');
                    value.href = result.frontmatter.url;
                    value.target = '_blank';
                    value.className = 'inspector-value';
                    value.style.color = '#6a8aaa';
                    value.style.textDecoration = 'none';
                    value.textContent = truncateUrl(result.frontmatter.url);
                    row.appendChild(label);
                    row.appendChild(value);
                    metaSection.appendChild(row);
                }

                container.appendChild(metaSection);
            }

            // Tags section
            if (result.tags && result.tags.length > 0) {
                const tagsSection = document.createElement('div');
                tagsSection.className = 'inspector-section';

                const tagsTitle = document.createElement('h3');
                tagsTitle.textContent = `Tags (${result.tags.length})`;
                tagsSection.appendChild(tagsTitle);

                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'inspector-tags';
                result.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'inspector-tag';
                    tagSpan.textContent = `#${tag}`;
                    tagsContainer.appendChild(tagSpan);
                });
                tagsSection.appendChild(tagsContainer);

                container.appendChild(tagsSection);
            }

            // Description section
            if (result.description) {
                const descSection = document.createElement('div');
                descSection.className = 'inspector-section';

                const descTitle = document.createElement('h3');
                descTitle.textContent = 'Description';
                descSection.appendChild(descTitle);

                const descText = document.createElement('div');
                descText.style.fontSize = '12px';
                descText.style.color = '#b0b0b0';
                descText.style.lineHeight = '1.5';
                descText.textContent = result.description;
                descSection.appendChild(descText);

                container.appendChild(descSection);
            }

            inspectorContent.replaceChildren(container);
        }

        function createScoreBar(label, displayValue, normalizedValue, tooltip = null) {
            const row = document.createElement('div');
            row.className = 'inspector-row';
            row.style.borderBottom = 'none';
            row.style.marginBottom = '6px';

            const labelDiv = document.createElement('div');
            labelDiv.className = 'inspector-label';
            labelDiv.style.display = 'flex';
            labelDiv.style.alignItems = 'center';
            labelDiv.style.gap = '4px';

            const labelText = document.createElement('span');
            labelText.textContent = label;
            labelDiv.appendChild(labelText);

            // Add tooltip if provided
            if (tooltip) {
                const tooltipWrapper = document.createElement('span');
                tooltipWrapper.className = 'tooltip-wrapper';
                tooltipWrapper.style.display = 'inline-block';

                const infoIcon = document.createElement('span');
                infoIcon.className = 'info-icon';
                infoIcon.textContent = '?';
                infoIcon.style.fontSize = '10px';
                infoIcon.style.cursor = 'help';

                const tooltipSpan = document.createElement('span');
                tooltipSpan.className = 'tooltip';
                tooltipSpan.innerHTML = tooltip;

                tooltipWrapper.appendChild(infoIcon);
                tooltipWrapper.appendChild(tooltipSpan);
                labelDiv.appendChild(tooltipWrapper);
            }

            const barContainer = document.createElement('div');
            barContainer.className = 'score-bar';
            barContainer.style.flex = '1';

            const valueDiv = document.createElement('div');
            valueDiv.className = 'score-value';
            valueDiv.textContent = typeof displayValue === 'number' ? displayValue.toFixed(3) : displayValue;

            const visualDiv = document.createElement('div');
            visualDiv.className = 'score-visual';

            const fillDiv = document.createElement('div');
            fillDiv.className = 'score-fill';
            fillDiv.style.width = `${Math.max(0, Math.min(100, normalizedValue * 100))}%`;

            visualDiv.appendChild(fillDiv);
            barContainer.appendChild(valueDiv);
            barContainer.appendChild(visualDiv);

            row.appendChild(labelDiv);
            row.appendChild(barContainer);

            return row;
        }

        function createInspectorRow(label, value) {
            const row = document.createElement('div');
            row.className = 'inspector-row';

            const labelDiv = document.createElement('div');
            labelDiv.className = 'inspector-label';
            labelDiv.textContent = label;

            const valueDiv = document.createElement('div');
            valueDiv.className = 'inspector-value mono';
            valueDiv.textContent = value;

            row.appendChild(labelDiv);
            row.appendChild(valueDiv);

            return row;
        }

        function truncateUrl(url, maxLen = 40) {
            if (!url || url.length <= maxLen) return url;
            return url.substring(0, maxLen - 3) + '...';
        }

        function formatDate(dateStr) {
            if (!dateStr) return null;
            try {
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch {
                return dateStr;
            }
        }

        // ========================================
        // Tooltip Positioning
        // ========================================

        // Smart tooltip positioning to prevent clipping
        document.addEventListener('mouseover', (e) => {
            const tooltipWrapper = e.target.closest('.tooltip-wrapper');
            if (!tooltipWrapper) return;

            const tooltip = tooltipWrapper.querySelector('.tooltip');
            if (!tooltip) return;

            const rect = tooltipWrapper.getBoundingClientRect();
            const tooltipWidth = 240; // Match CSS width
            const tooltipHeight = tooltip.offsetHeight || 200; // Estimate if not rendered

            // Position below the icon by default
            let top = rect.bottom + 8;
            let left = rect.left;

            // If tooltip would go off right edge, align to right
            if (left + tooltipWidth > window.innerWidth - 10) {
                left = rect.right - tooltipWidth;
            }

            // If tooltip would go off bottom, show above instead
            if (top + tooltipHeight > window.innerHeight - 10) {
                top = rect.top - tooltipHeight - 8;
            }

            // Prevent going off left edge
            if (left < 10) {
                left = 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        });

        // Start the app
        initialize();
    </script>
</body>
</html>
