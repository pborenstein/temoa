<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Temoa Management</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Temoa">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #1a1a1a;
            padding: 16px;
            line-height: 1.5;
            color: #e0e0e0;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 16px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 4px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: #ffffff;
            flex-shrink: 1;
        }

        .subtitle {
            color: #888888;
            font-size: 13px;
        }

        .nav-link {
            color: #888888;
            text-decoration: none;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-link:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .vault-selector {
            margin-bottom: 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .vault-selector-label {
            color: #888888;
            font-size: 12px;
        }

        .vault-select {
            display: inline-block;
            width: auto;
            min-width: 150px;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .vault-select:focus {
            border-color: #666666;
        }

        .vault-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .vault-info {
            font-size: 12px;
            color: #888888;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .vault-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            background: #2a2a2a;
            border: 1px solid #404040;
            font-size: 11px;
            color: #888888;
        }

        .vault-badge.default {
            background: #1a3a1a;
            border-color: #2a5a2a;
            color: #6a6;
        }

        .vault-badge.indexed {
            background: #1a1a3a;
            border-color: #2a2a5a;
            color: #66a;
        }

        .section {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333333;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #888888;
            font-size: 14px;
        }

        .stat-value {
            color: #e0e0e0;
            font-weight: 500;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-healthy {
            background: #4caf50;
        }

        .status-unhealthy {
            background: #f44336;
        }

        .action-button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            background: #404040;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 12px;
        }

        .action-button:hover {
            background: #4a4a4a;
        }

        .action-button:active {
            background: #505050;
        }

        .action-button:disabled {
            background: #2a2a2a;
            color: #666666;
            cursor: not-allowed;
        }

        .action-button.danger {
            background: #5a3a1a;
        }

        .action-button.danger:hover {
            background: #6a4a2a;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            color: #e0e0e0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #888888;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #404040;
            border-top-color: #888888;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .message.active {
            display: block;
        }

        .message.success {
            background: #2a4a2a;
            border: 1px solid #3a5a3a;
            color: #88cc88;
        }

        .message.error {
            background: #3a2a1a;
            border: 1px solid #5a3a1a;
            color: #ffcc99;
        }

        footer {
            text-align: center;
            padding: 0.5rem;
            margin-top: 1rem;
            border-top: 1px solid #404040;
            font-size: 0.7rem;
            color: #666666;
        }

        footer a {
            color: #e0e0e0;
            text-decoration: none;
        }

        footer a:hover {
            color: #b0b0b0;
            text-decoration: underline;
        }

        .progress-container {
            margin: 12px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #404040;
        }

        .progress-fill.indeterminate {
            height: 100%;
            background: repeating-linear-gradient(
                45deg,
                #4a4a4a,
                #4a4a4a 10px,
                #606060 10px,
                #606060 20px
            );
            background-size: 28px 28px;
            animation: barber-pole 1s linear infinite;
            width: 100%;
        }

        @keyframes barber-pole {
            0% { background-position: 0 0; }
            100% { background-position: 28px 0; }
        }

        .progress-text {
            font-size: 13px;
            color: #888888;
            margin-top: 6px;
            text-align: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0;
        }

        .stat-grid .stat-row {
            border-bottom: 1px solid #333333;
            padding: 8px 12px;
        }

        .stat-grid .stat-row:last-child {
            border-bottom: 1px solid #333333;
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 24px;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .nav-link {
                align-self: flex-end;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>Temoa Management</h1>
                <a href="/" class="nav-link">Search</a>
            </div>
            <p class="subtitle">System health, stats, and operations</p>
        </header>

        <!-- Vault Selector -->
        <div class="vault-selector">
            <label class="vault-selector-label">Vault:</label>
            <select id="vault-select" class="vault-select" onchange="onVaultChange()">
                <option value="">Loading vaults...</option>
            </select>
            <span id="vault-info" class="vault-info"></span>
        </div>

        <div class="message" id="message"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div style="margin-top: 8px;">Processing...</div>
        </div>

        <!-- Vault Management Section -->
        <div class="section">
            <h2 class="section-title">Vault Management</h2>

            <!-- Current Index Status -->
            <div style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #404040;">
                <div style="font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Current Index Status</div>
                <div class="stat-row">
                    <span class="stat-label">Status</span>
                    <span class="stat-value" id="health-status">
                        <span class="status-indicator"></span>Loading...
                    </span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Model</span>
                    <span class="stat-value" id="health-model">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Files indexed</span>
                    <span class="stat-value" id="health-files">-</span>
                </div>
                <div class="stat-row" id="chunking-status-row">
                    <span class="stat-label">Chunking</span>
                    <span class="stat-value" id="chunking-status">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last indexed</span>
                    <span class="stat-value" id="adv-last-indexed">-</span>
                </div>
            </div>

            <!-- Reindex Action -->
            <button class="action-button" id="reindex-btn" onclick="reindex()">
                Reindex Vault
            </button>

            <div style="margin-top: 12px; margin-bottom: 12px;">
                <div class="checkbox-group">
                    <input type="checkbox" id="full-rebuild">
                    <label for="full-rebuild">Full rebuild (process all files)</label>
                </div>
            </div>

            <details open style="margin-bottom: 24px;">
                <summary style="cursor: pointer; font-size: 14px; color: #888888; padding: 8px 0; user-select: none;">
                    Index Options
                </summary>
                <div style="padding: 12px 0 0 16px; border-left: 2px solid #404040; margin-left: 8px;">
                    <div style="font-size: 12px; color: #666666; margin-bottom: 12px; font-style: italic;">
                        These settings apply to the next reindex operation
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 13px; color: #888888; margin-bottom: 4px;">
                            Embedding Model
                        </label>
                        <select id="model-select" class="vault-select" style="width: 100%;">
                            <option value="">Loading models...</option>
                        </select>
                        <div style="font-size: 12px; color: #666666; margin-top: 4px;">
                            Note: Changing model requires server restart
                        </div>
                    </div>

                    <div class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="enable-chunking">
                        <label for="enable-chunking">Enable chunking for large files</label>
                    </div>

                    <div id="chunking-options" style="display: none; padding-left: 28px; margin-bottom: 12px;">
                        <div style="margin-bottom: 8px;">
                            <label style="display: block; font-size: 13px; color: #888888; margin-bottom: 4px;">
                                Chunk size (characters)
                            </label>
                            <input type="number" id="chunk-size" value="2000" min="500" max="5000" step="100"
                                   style="width: 100%; padding: 6px 10px; font-size: 13px; border: 1px solid #404040; border-radius: 6px; background: #1a1a1a; color: #e0e0e0;">
                        </div>
                        <div style="margin-bottom: 8px;">
                            <label style="display: block; font-size: 13px; color: #888888; margin-bottom: 4px;">
                                Chunk overlap (characters)
                            </label>
                            <input type="number" id="chunk-overlap" value="400" min="0" max="1000" step="50"
                                   style="width: 100%; padding: 6px 10px; font-size: 13px; border: 1px solid #404040; border-radius: 6px; background: #1a1a1a; color: #e0e0e0;">
                        </div>
                        <div style="margin-bottom: 8px;">
                            <label style="display: block; font-size: 13px; color: #888888; margin-bottom: 4px;">
                                Chunking threshold (characters)
                            </label>
                            <input type="number" id="chunk-threshold" value="4000" min="1000" max="10000" step="500"
                                   style="width: 100%; padding: 6px 10px; font-size: 13px; border: 1px solid #404040; border-radius: 6px; background: #1a1a1a; color: #e0e0e0;">
                        </div>
                    </div>
                </div>
            </details>

            <!-- Advanced Statistics -->
            <details open style="margin-top: 20px;">
                <summary style="cursor: pointer; font-size: 14px; color: #888888; padding: 8px 0; user-select: none;">
                    Advanced Statistics
                </summary>
                <div style="padding: 12px 0 0 0;">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Tag Distribution (top 10)</div>
                        <div id="adv-tag-distribution">
                            <div style="text-align: center; color: #888888; padding: 12px;">Loading...</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Content Types</div>
                        <div id="adv-type-distribution">
                            <div style="text-align: center; color: #888888; padding: 12px;">Loading...</div>
                        </div>
                    </div>

                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Index Health</div>
                        <div class="stat-row">
                            <span class="stat-label">Status</span>
                            <span class="stat-value" id="adv-index-status">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Stale files</span>
                            <span class="stat-value" id="adv-stale-files">-</span>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- Gleaning Management Section -->
        <div class="section">
            <h2 class="section-title">Gleaning Management</h2>

            <!-- Gleaning Stats -->
            <div style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #404040;">
                <div class="stat-row">
                    <span class="stat-label">Active gleanings</span>
                    <span class="stat-value" id="gleaning-active">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Inactive gleanings</span>
                    <span class="stat-value" id="gleaning-inactive">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hidden gleanings</span>
                    <span class="stat-value" id="gleaning-hidden">-</span>
                </div>
            </div>

            <!-- Extract Action -->
            <button class="action-button" id="extract-btn" onclick="extract()">
                Extract Gleanings
            </button>

            <div style="margin-top: 12px; margin-bottom: 16px;">
                <div class="checkbox-group">
                    <input type="checkbox" id="incremental" checked>
                    <label for="incremental">Incremental (only new files)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="auto-reindex" checked>
                    <label for="auto-reindex">Auto-reindex after extraction</label>
                </div>
            </div>

            <!-- View Inactive Button -->
            <button class="action-button" id="view-inactive-btn" onclick="viewInactiveGleanings()">
                View Inactive Gleanings
            </button>
        </div>

        <footer>
            <a href="https://github.com/pborenstein/temoa">temoa</a>
            &copy; 2025
            <a href="https://pborenstein.dev">Philip Borenstein</a>
            /
            Made in New England
            <svg style="display: inline-block; width: 20px; height: 12px; margin-left: 4px; vertical-align: middle;" viewBox="0 0 720 432" xmlns="http://www.w3.org/2000/svg">
                <rect fill="#BF0000" width="720" height="432"/>
                <rect fill="#FFFFFF" width="216" height="216"/>
                <path fill="#8B5C29" d="M114.15,170.029c0.014,5.968-0.477,11.827-0.515,17.716c-0.014,2.087,0.094,4.623,0.532,6.655c0.371,1.723,1.579,3.449,1.61,5.309c1.604,0.192,1.417,2.074,2.89,2.24c3.276,5.972-4.25,4.03-8.133,4.017c-2.596-0.009-5.317,0.471-7.708,0.374c-2.542-0.102-4.343-0.099-6.985,0.693c0.775-0.864,1.915-1.14,2.653-2.073c1.315-1.661,0.982-3.981,1.256-5.948c0.48-3.446,0.51-6.72,0.543-10.222c0.03-3.22,0.646-6.491,1.014-9.534c0.379-3.143,0.017-6.566,0.012-9.74"/>
                <path fill="#00A33D" d="M106.451,177.728c-0.659,0.771-2.116,2.905-3.317,2.956c-0.677,0.028-0.791-0.767-1.382-0.835c-1.293-0.15-2.95-0.131-4.254-0.084c-3.118,0.112-6.175,0.19-9.288-0.195c-5.419-0.671-9.691-0.84-14.821,1.004c-2.198,0.791-4.47,0.994-6.891,0.757c-2.634-0.257-5.513-0.324-8.1-0.917c-2.044-0.468-5.359-1.641-3.124-4.239c2.086-2.422,5.909-0.999,7.908-2.977c-5.916-0.576-11.514,1.969-17.245,1.207c-2.225-0.295-6.479-0.411-4.526-3.638c1.237-2.043,4.039-3.845,4.58-6.283c1.443-0.231,2.658-2.697,3.968-3.55c1.415-0.921,3.485-1.811,5.079-2.284c0.805-2.183-1.333-2.853-1.97-4.477c-0.942-2.404,1.583-3.115,2.159-5.085c0.276-0.067,0.552-0.133,0.829-0.197c0.064-0.276,0.129-0.554,0.196-0.83c0.945-0.081,2.306-1.621,2.98-2.273c0.959-0.927,3.269-2.896,3.555-3.886c-3.207,0.052-0.782-3.19,0.211-4.096c1.622-1.482,3.088-2.2,4.813-3.332c1.044-0.686,3.19-2.747,2.736-4.204c-0.56-1.798-3.338-1.085-4.04-2.892c-1.123-2.891,3.778-7.663,5.296-10.006c1.02-1.576,2.386-2.687,3.733-3.944c1.773-1.655,2.878-3.862,4.573-5.562c-3.283,0.325-6.411-0.641-9.504-0.528c-1.313-3.878,6.129-7.486,8.178-9.531c1.532-1.53,2.78-3.687,4.41-5.291c1.409-1.387,3.391-4.042,5.114-4.628c-2.75-0.049-5.117,2.07-7.951,1.488c-0.66-2.025,3.381-6.556,4.343-8.393c1.374-2.622,4.216-5.47,4.853-8.503c1.038-4.941-3.487-2.807-4.999-5.742c-1.485-2.881,4.017-4.102,4.961-5.451c0.809-1.155,0.862-3.811,0.021-4.947c-0.834-1.126-2.029-0.736-2.104-2.371c-0.132-2.932,3.591-5.725,4.49-8.142c0.585-1.572-0.176-3.076-0.337-4.579c-0.174-1.611,0.401-3.653,1.082-5.035c0.461-0.936,1.487-1.887,1.98-3.054c0.356-0.846,0.654-1.671,1.024-2.52c0.759-1.744,1.573-3.308,2.331-5.197c0.955-2.379,3.654-3.548,4.824-5.754c0.821-1.548,0.292-3.377,1.16-4.991c0.654-1.212,1.341-1.934,1.723-3.256c-0.185-0.106-0.278-0.277-0.284-0.515l4.106-3.592c0.703,1.062,0.862,2.783,1.405,3.979c0.49,1.08,0.988,2.156,1.548,3.204c0.768,1.439,1.522,2.849,2.084,4.2c1.38,3.323,2.236,6.437,3.909,9.645c0.758,1.453,1.75,2.673,2.355,4.079c0.779,1.809,0.788,3.547,1.253,5.419c0.43,1.733,1.391,3.207,1.798,4.881c0.417,1.71,2.248,4.455,2.006,6.087c-0.787,0.03-1.67,0.012-2.447,0.181c1.553,3.237,5.245,5.556,7.414,8.364c1.064,1.38,1.237,2.384,1.79,3.822c0.419,1.092,1.137,2.117,1.003,3.32c-0.06,0.541-0.567,1.026-0.594,1.754c-0.285,0.056-0.569,0.113-0.853,0.173c-0.58,1.76,0.959,3.569,1.704,5.048c1.098,2.178,0.684,2.021-0.389,4.066c-1.116,2.13-0.914,3.538-0.366,5.683c0.306,1.2,0.131,1.724,1.006,2.83c0.613,0.774,1.451,1.217,1.646,2.202c0.275,0.072,0.553,0.134,0.833,0.189c0.268,1.856,3.144,3.968,2.693,6.083c-0.533,2.495-3.82,1.715-0.563,4.817c2.303,2.195,8.194,5.46,7.652,9.463c-2.047,0.115-3.539,1.29-5.513,1.193c0.25,1.777,3.247,2.755,4.385,4.131c1.618,1.956,2.957,4.649,5.307,5.831c2.662,1.338,11.009,4.133,4.625,7.38c-1.801,0.915-10.238,0.596-9.015,3.635c1.022,2.539,5.035,1.692,1.314,4.172c-2.718,1.812-4.869,1.769-8.094,2.18c0.958,1.79,4.134,4.129,5.709,4.846c1.166,0.532,2.744,0.302,4.004,0.662c3.18,0.906,5.853,2.899,8.916,4.088c2.311,0.897,4.728,1.903,6.799,2.995c1.963,1.036,3.902,3.257,5.921,4.206c-2.742,1.363-8.363,3.684-11.745,3.556c-1.226-0.047-1.769-0.463-3.103-0.333c-1.995,0.195-3.461,0.956-5.506,0.78c3.402,1.388,8.062,0.741,10.97,3.062c2.256,1.8,2.247,4.787,5.378,5.921c2.095,0.758,4.279,0.754,6.477,1.388c1.771,0.512,3.354,0.634,5.062,1.057c1.856,0.458,1.959,1.229,2.508,2.864c-0.933,0.627-2.056,0.844-3.046,1.4c-1.701,0.958-2.596,2.857-4.1,3.766c-2.162,1.306-6.182,2.48-8.712,2.148c-3.652-0.479-6.491,0.374-10.233,0.496c-2.258,0.075-4.304,1.029-6.563,1.107c1.459,1.327,2.812,2.674,4.452,3.811c1.666,1.155,3.636,1.812,5.079,3.412c-0.984,2.847-8.668,1.344-10.879,0.849c-1.995-0.448-3.829-0.442-5.926-0.451c-3.283-0.015-5.539-0.708-8.729-1.309c-9.681-1.825-16.693-10.305-27.197-8.89c-0.019,0.789,0.374,1.167,0.973,1.464L106.451,177.728z"/>
            </svg>
            /
            <a href="/docs">API</a>
            â€¢
            <span style="color: #555555;">v{{VERSION}}</span>
        </footer>
    </div>

    <script>
        const messageDiv = document.getElementById('message');
        const loadingDiv = document.getElementById('loading');
        const vaultSelect = document.getElementById('vault-select');
        const vaultInfo = document.getElementById('vault-info');

        // ========================================
        // State Management
        // ========================================
        const STORAGE_VERSION = 1;
        const STORAGE_KEY = `temoa_v${STORAGE_VERSION}_ui_state`;

        const state = {
            vaults: [],
            currentVault: null,
            defaultVault: null
        };

        // Get vault from URL parameter, localStorage, or default (priority order)
        function getCurrentVault() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlVault = urlParams.get('vault');
            if (urlVault) return urlVault;

            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data.currentVault) return data.currentVault;
                } catch (e) {}
            }

            return state.defaultVault;
        }

        // Save current vault to localStorage
        function saveCurrentVault() {
            try {
                const toSave = { currentVault: state.currentVault };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            } catch (err) {
                console.warn('Failed to save vault to localStorage:', err);
            }
        }

        // Fetch available vaults from API
        async function fetchVaults() {
            try {
                const response = await fetch('/vaults');
                if (!response.ok) throw new Error('Failed to fetch vaults');

                const data = await response.json();
                state.vaults = data.vaults;
                state.defaultVault = data.default_vault;

                populateVaultSelector();

                const selectedVault = getCurrentVault();
                if (selectedVault) {
                    state.currentVault = selectedVault;
                    vaultSelect.value = selectedVault;
                    updateVaultInfo();
                }
            } catch (err) {
                console.error('Failed to fetch vaults:', err);
                vaultSelect.innerHTML = '<option value="">Error loading vaults</option>';
            }
        }

        // Populate vault selector dropdown
        function populateVaultSelector() {
            vaultSelect.innerHTML = '';

            state.vaults.forEach(vault => {
                const option = document.createElement('option');
                option.value = vault.name;
                option.textContent = vault.name;
                vaultSelect.appendChild(option);
            });
        }

        // Update vault info display
        function updateVaultInfo() {
            const vault = state.vaults.find(v => v.name === state.currentVault);
            if (!vault) {
                vaultInfo.innerHTML = '';
                return;
            }

            vaultInfo.innerHTML = '';

            if (vault.is_default) {
                const badge = document.createElement('span');
                badge.className = 'vault-badge default';
                badge.textContent = 'default';
                vaultInfo.appendChild(badge);
            }

            if (vault.indexed) {
                const badge = document.createElement('span');
                badge.className = 'vault-badge indexed';
                badge.textContent = `${vault.file_count} files indexed`;
                vaultInfo.appendChild(badge);
            } else {
                const badge = document.createElement('span');
                badge.className = 'vault-badge';
                badge.textContent = 'not indexed';
                vaultInfo.appendChild(badge);
            }
        }

        // Handle vault change
        function onVaultChange() {
            state.currentVault = vaultSelect.value;
            saveCurrentVault();
            updateVaultInfo();

            // Update URL parameter (for shareable links)
            const url = new URL(window.location);
            url.searchParams.set('vault', state.currentVault);
            window.history.replaceState({}, '', url);

            // Reload config and stats for new vault
            loadVaultConfig();
            loadHealth();
            loadGleaningStats();
            loadAdvancedStats();
        }

        // Load vault configuration and populate form controls
        async function loadVaultConfig() {
            try {
                let url = '/config';
                if (state.currentVault) {
                    url += `?vault=${encodeURIComponent(state.currentVault)}`;
                }

                const response = await fetch(url);
                if (!response.ok) return;

                const data = await response.json();

                // Get the vault config
                const vaultConfig = data.vaults?.[state.currentVault];
                if (!vaultConfig) return;

                // Populate chunking settings
                const enableChunking = vaultConfig.enable_chunking || false;
                document.getElementById('enable-chunking').checked = enableChunking;
                document.getElementById('chunking-options').style.display =
                    enableChunking ? 'block' : 'none';

                if (vaultConfig.chunk_size) {
                    document.getElementById('chunk-size').value = vaultConfig.chunk_size;
                }
                if (vaultConfig.chunk_overlap) {
                    document.getElementById('chunk-overlap').value = vaultConfig.chunk_overlap;
                }
                if (vaultConfig.chunk_threshold) {
                    document.getElementById('chunk-threshold').value = vaultConfig.chunk_threshold;
                }
            } catch (error) {
                console.error('Failed to load vault config:', error);
            }
        }

        // Load health and stats on page load
        window.addEventListener('load', async () => {
            await fetchVaults();
            await loadModels();
            await loadVaultConfig();
            loadHealth();
            loadGleaningStats();
            loadAdvancedStats();

            // Setup chunking options toggle
            document.getElementById('enable-chunking').addEventListener('change', (e) => {
                document.getElementById('chunking-options').style.display =
                    e.target.checked ? 'block' : 'none';
            });
        });

        async function loadHealth() {
            try {
                let url = '/health';
                if (state.currentVault) {
                    url += `?vault=${encodeURIComponent(state.currentVault)}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                displayHealth(data);
            } catch (error) {
                console.error('Failed to load health:', error);
                document.getElementById('health-status').innerHTML =
                    '<span class="status-indicator status-unhealthy"></span>Error';
            }
        }

        function displayHealth(data) {
            const statusEl = document.getElementById('health-status');
            const modelEl = document.getElementById('health-model');
            const filesEl = document.getElementById('health-files');

            const isHealthy = data.status === 'healthy';
            const statusClass = isHealthy ? 'status-healthy' : 'status-unhealthy';
            const statusText = isHealthy ? 'Healthy' : 'Unhealthy';

            statusEl.innerHTML = `<span class="status-indicator ${statusClass}"></span>${statusText}`;
            modelEl.textContent = data.model || 'Unknown';
            filesEl.textContent = data.files_indexed?.toLocaleString() || '0';
        }

        async function loadModels() {
            try {
                const response = await fetch('/models');
                const data = await response.json();
                displayModels(data.models);
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        function displayModels(models) {
            const select = document.getElementById('model-select');
            select.innerHTML = '';

            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.dimensions}d) - ${model.description}`;
                if (model.default) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        async function loadGleaningStats() {
            try {
                let url = '/gleaning/stats';
                if (state.currentVault) {
                    url += `?vault=${encodeURIComponent(state.currentVault)}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                displayGleaningStats(data);
            } catch (error) {
                console.error('Failed to load gleaning stats:', error);
            }
        }

        function displayGleaningStats(data) {
            document.getElementById('gleaning-active').textContent =
                data.active?.toLocaleString() || '0';
            document.getElementById('gleaning-inactive').textContent =
                data.inactive?.toLocaleString() || '0';
            document.getElementById('gleaning-hidden').textContent =
                data.hidden?.toLocaleString() || '0';
        }

        async function loadAdvancedStats() {
            try {
                let url = '/stats/advanced';
                if (state.currentVault) {
                    url += `?vault=${encodeURIComponent(state.currentVault)}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                displayAdvancedStats(data);
            } catch (error) {
                console.error('Failed to load advanced stats:', error);
            }
        }

        function displayAdvancedStats(data) {
            // Coverage - chunking status
            const coverage = data.coverage || {};
            const chunksPerFile = coverage.chunks_per_file || 0;
            const chunksCreated = coverage.chunks_created || 0;
            const filesIndexed = coverage.files_indexed || 0;

            // Display chunking status clearly
            const chunkingStatusEl = document.getElementById('chunking-status');
            if (chunksPerFile > 1.01) {
                // Chunking is enabled
                chunkingStatusEl.textContent =
                    `Enabled (${chunksCreated.toLocaleString()} chunks, ${chunksPerFile.toFixed(1)}x per file)`;
            } else {
                // No chunking
                chunkingStatusEl.textContent = 'Not enabled';
            }

            // Tag distribution
            const tags = data.tags || {};
            const tagDistEl = document.getElementById('adv-tag-distribution');
            if (tags.top_tags && tags.top_tags.length > 0) {
                const rows = tags.top_tags.map(t =>
                    `<div class="stat-row">
                        <span class="stat-label">${t.tag}</span>
                        <span class="stat-value">${t.count.toLocaleString()}</span>
                    </div>`
                ).join('');
                tagDistEl.innerHTML = `<div class="stat-grid">${rows}</div>`;
            } else {
                tagDistEl.innerHTML = '<div style="text-align: center; color: #888888; padding: 12px;">No tags found</div>';
            }

            // Type distribution
            const types = data.types || {};
            const typeDistEl = document.getElementById('adv-type-distribution');
            const typeEntries = Object.entries(types).sort((a, b) => b[1] - a[1]); // Sort by count descending
            if (typeEntries.length > 0) {
                const rows = typeEntries.map(([type, count]) =>
                    `<div class="stat-row">
                        <span class="stat-label">${type}</span>
                        <span class="stat-value">${count.toLocaleString()}</span>
                    </div>`
                ).join('');
                typeDistEl.innerHTML = `<div class="stat-grid">${rows}</div>`;
            } else {
                typeDistEl.innerHTML = '<div style="text-align: center; color: #888888; padding: 12px;">No type information available</div>';
            }

            // Index health
            const health = data.index_health || {};
            const statusEl = document.getElementById('adv-index-status');
            const isHealthy = health.status === 'healthy';
            const statusClass = isHealthy ? 'status-healthy' : 'status-unhealthy';
            const statusText = health.status || 'Unknown';
            statusEl.innerHTML = `<span class="status-indicator ${statusClass}"></span>${statusText}`;

            // Last indexed - moved to Current Index Status section
            document.getElementById('adv-last-indexed').textContent =
                health.last_indexed || 'Never';
            document.getElementById('adv-stale-files').textContent =
                health.stale_files?.toLocaleString() || '0';
        }

        function viewInactiveGleanings() {
            const vault = state.currentVault || '';
            let url = '/gleanings?status=inactive';
            if (vault) {
                url += `&vault=${encodeURIComponent(vault)}`;
            }
            window.open(url, '_blank');
        }

        async function reindex() {
            const fullRebuild = document.getElementById('full-rebuild').checked;

            // Show confirmation dialog for full rebuild
            if (fullRebuild && !confirm('This will rebuild all embeddings. Continue?')) {
                return;
            }

            const button = document.getElementById('reindex-btn');
            button.disabled = true;
            button.textContent = 'Reindexing...';
            messageDiv.classList.remove('active');

            // Create indeterminate progress bar
            const progressDiv = document.createElement('div');
            progressDiv.className = 'progress-container';
            progressDiv.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill indeterminate"></div>
                </div>
                <div class="progress-text">${fullRebuild ? 'Full rebuild in progress...' : 'Reindexing changed files...'}</div>
            `;
            button.after(progressDiv);

            try {
                let url = `/reindex?force=${fullRebuild}`;
                if (state.currentVault) {
                    url += `&vault=${encodeURIComponent(state.currentVault)}`;
                }

                // Add chunking parameters
                const enableChunking = document.getElementById('enable-chunking').checked;
                if (enableChunking) {
                    const chunkSize = document.getElementById('chunk-size').value;
                    const chunkOverlap = document.getElementById('chunk-overlap').value;
                    const chunkThreshold = document.getElementById('chunk-threshold').value;

                    url += `&enable_chunking=true`;
                    url += `&chunk_size=${chunkSize}`;
                    url += `&chunk_overlap=${chunkOverlap}`;
                    url += `&chunk_threshold=${chunkThreshold}`;
                }

                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    let message = `Successfully reindexed ${data.files_indexed?.toLocaleString() || 0} files`;
                    if (data.new_files || data.modified_files || data.deleted_files) {
                        message += ` (${data.new_files || 0} new, ${data.modified_files || 0} modified, ${data.deleted_files || 0} deleted)`;
                    }
                    showMessage(message, 'success');
                    // Refresh health and stats
                    await loadHealth();
                    await loadGleaningStats();
                    await loadAdvancedStats();
                } else {
                    throw new Error(data.detail || 'Reindex failed');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                console.error('Reindex error:', error);
            } finally {
                progressDiv.remove();
                button.disabled = false;
                button.textContent = 'Reindex Vault';
            }
        }

        async function extract() {
            const incremental = document.getElementById('incremental').checked;
            const autoReindex = document.getElementById('auto-reindex').checked;

            const button = document.getElementById('extract-btn');
            button.disabled = true;
            button.textContent = 'Extracting...';
            loadingDiv.classList.add('active');
            messageDiv.classList.remove('active');

            try {
                let url = `/extract?incremental=${incremental}&auto_reindex=${autoReindex}`;
                if (state.currentVault) {
                    url += `&vault=${encodeURIComponent(state.currentVault)}`;
                }

                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showMessage(
                        `Found ${data.total_gleanings || 0} gleanings, ` +
                        `created ${data.new_gleanings || 0} new, ` +
                        `skipped ${data.duplicates || 0} duplicates`,
                        'success'
                    );
                    // Refresh gleaning stats
                    await loadGleaningStats();
                } else {
                    throw new Error(data.detail || 'Extraction failed');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                console.error('Extract error:', error);
            } finally {
                loadingDiv.classList.remove('active');
                button.disabled = false;
                button.textContent = 'Extract Gleanings';
            }
        }

        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type} active`;

            // Auto-hide after 10 seconds
            setTimeout(() => {
                messageDiv.classList.remove('active');
            }, 10000);
        }

        // ========================================
        // PWA Service Worker Registration
        // ========================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
