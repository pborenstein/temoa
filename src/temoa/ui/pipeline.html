<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Viewer - Temoa</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #1a1a1a;
            padding: 16px;
            line-height: 1.5;
            color: #e0e0e0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .nav-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #888888;
            text-decoration: none;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        /* Search controls */
        .search-section {
            background: #232323;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .search-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .search-input {
            flex: 1;
            padding: 10px 14px;
            font-size: 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
        }

        .search-input:focus {
            border-color: #666666;
        }

        .btn {
            padding: 10px 16px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 500;
        }

        .btn-primary {
            background: #4a9eff;
            color: white;
        }

        .btn-primary:hover {
            background: #3a8eef;
        }

        .btn-secondary {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #4a4a4a;
        }

        .selector-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .selector-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selector-label {
            color: #888888;
            font-size: 13px;
        }

        .select {
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            cursor: pointer;
        }

        /* Pipeline stages */
        .pipeline-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stage {
            background: #232323;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333333;
        }

        .stage-header {
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }

        .stage-header:hover {
            background: #282828;
        }

        .stage-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stage-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #3a3a3a;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #888888;
        }

        .stage-name {
            font-size: 15px;
            font-weight: 500;
            color: #ffffff;
        }

        .stage-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .stage-count {
            color: #888888;
        }

        .stage-timing {
            color: #4a9eff;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .stage-arrow {
            color: #888888;
            transition: transform 0.2s;
        }

        .stage-arrow.expanded {
            transform: rotate(90deg);
        }

        .stage-content {
            padding: 0 16px 16px;
            display: none;
        }

        .stage-content.expanded {
            display: block;
        }

        .stage-metadata {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .metadata-row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }

        .metadata-row:last-child {
            margin-bottom: 0;
        }

        .metadata-label {
            color: #888888;
            min-width: 120px;
        }

        .metadata-value {
            color: #e0e0e0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }

        .results-preview {
            background: #2a2a2a;
            border-radius: 6px;
            overflow: hidden;
        }

        .preview-header {
            padding: 10px 12px;
            background: #323232;
            font-size: 12px;
            font-weight: 500;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-item {
            padding: 10px 12px;
            border-bottom: 1px solid #333333;
            font-size: 13px;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-path {
            color: #4a9eff;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .result-scores {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 11px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .score-badge {
            padding: 2px 6px;
            background: #3a3a3a;
            border-radius: 4px;
            color: #888888;
        }

        .score-badge.highlight {
            background: #4a5a3a;
            color: #9aff6a;
        }

        .rank-change {
            padding: 10px 12px;
            border-bottom: 1px solid #333333;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank-change:last-child {
            border-bottom: none;
        }

        .rank-change-path {
            color: #e0e0e0;
            flex: 1;
            margin-right: 12px;
        }

        .rank-change-delta {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .rank-change-delta.up {
            background: #3a5a3a;
            color: #9aff6a;
        }

        .rank-change-delta.down {
            background: #5a3a3a;
            color: #ff6a6a;
        }

        .summary-box {
            background: #232323;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #333333;
        }

        .summary-title {
            font-size: 15px;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 12px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-label {
            color: #888888;
            font-size: 12px;
        }

        .summary-value {
            color: #4a9eff;
            font-size: 18px;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888888;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #888888;
        }

        .error {
            background: #5a3a3a;
            color: #ff9a9a;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .export-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #3a3a3a;
            color: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #4a4a4a;
            transform: scale(1.1);
        }

        @media (max-width: 600px) {
            .selector-row {
                flex-direction: column;
                align-items: stretch;
            }

            .selector-group {
                width: 100%;
            }

            .select {
                flex: 1;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pipeline Step Viewer</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">Search</a>
                <a href="/harness" class="nav-link">Harness</a>
            </div>
        </header>

        <div class="search-section">
            <div class="search-row">
                <input type="text" id="query" class="search-input" placeholder="Enter search query..." autocomplete="off">
                <button onclick="runPipeline()" class="btn btn-primary">Run</button>
                <button onclick="clearResults()" class="btn btn-secondary">Clear</button>
            </div>
            <div class="selector-row">
                <div class="selector-group">
                    <span class="selector-label">Vault:</span>
                    <select id="vaultSelect" class="select"></select>
                </div>
                <div class="selector-group">
                    <span class="selector-label">Profile:</span>
                    <select id="profileSelect" class="select">
                        <option value="default">Default</option>
                        <option value="repos">Repos</option>
                        <option value="recent">Recent</option>
                        <option value="deep">Deep</option>
                        <option value="keywords">Keywords</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="results"></div>

        <button id="exportBtn" class="export-btn" onclick="exportPipeline()" style="display: none;" title="Export to JSON">üì•</button>
    </div>

    <script>
        let currentPipelineData = null;

        // Load vaults on page load
        async function loadVaults() {
            try {
                const response = await fetch('/vaults');
                const data = await response.json();
                const select = document.getElementById('vaultSelect');
                select.innerHTML = '';

                data.vaults.forEach(vault => {
                    const option = document.createElement('option');
                    option.value = vault.name;
                    option.textContent = vault.name;
                    if (vault.is_default) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load vaults:', error);
            }
        }

        // Run pipeline
        async function runPipeline() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const vault = document.getElementById('vaultSelect').value;
            const profile = document.getElementById('profileSelect').value;
            const resultsDiv = document.getElementById('results');

            // Show loading
            resultsDiv.innerHTML = '<div class="loading">Running pipeline... this may take a few seconds</div>';

            try {
                const params = new URLSearchParams({
                    q: query,
                    vault: vault,
                    profile: profile,
                    pipeline_debug: 'true',
                    limit: '20'
                });

                const response = await fetch(`/search?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Search failed');
                }

                if (!data.pipeline) {
                    throw new Error('Pipeline data not available. Ensure pipeline_debug=true is working.');
                }

                currentPipelineData = data;
                renderPipeline(data.pipeline);
                document.getElementById('exportBtn').style.display = 'block';

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Pipeline error:', error);
            }
        }

        // Render pipeline
        function renderPipeline(pipeline) {
            const resultsDiv = document.getElementById('results');

            if (!pipeline || !pipeline.stages || pipeline.stages.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><div>No pipeline data available</div></div>';
                return;
            }

            let html = '';

            // Summary box
            html += `
                <div class="summary-box">
                    <div class="summary-title">Pipeline Summary</div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Time</div>
                            <div class="summary-value">${pipeline.summary.total_time_ms}ms</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Initial Results</div>
                            <div class="summary-value">${pipeline.summary.initial_results}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Final Results</div>
                            <div class="summary-value">${pipeline.summary.final_results}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Filtered</div>
                            <div class="summary-value">${pipeline.summary.total_filtered} (${Math.round(pipeline.summary.total_filtered / pipeline.summary.initial_results * 100)}%)</div>
                        </div>
                    </div>
                </div>
            `;

            // Stages
            html += '<div class="pipeline-container">';

            pipeline.stages.forEach((stage, idx) => {
                html += renderStage(stage, idx);
            });

            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        // Render individual stage
        function renderStage(stage, idx) {
            let html = `
                <div class="stage">
                    <div class="stage-header" onclick="toggleStage(${idx})">
                        <div class="stage-title">
                            <div class="stage-number">${stage.stage_num}</div>
                            <div class="stage-name">${stage.stage_name}</div>
                        </div>
                        <div class="stage-meta">
                            <span class="stage-count">${stage.result_count} results</span>
                            <span class="stage-timing">${stage.timing_ms}ms</span>
                            <span class="stage-arrow" id="arrow-${idx}">‚ñ∂</span>
                        </div>
                    </div>
                    <div class="stage-content" id="stage-${idx}">
            `;

            // Metadata section
            html += renderStageMetadata(stage);

            // Results preview
            if (stage.results_preview && stage.results_preview.length > 0) {
                html += renderResultsPreview(stage.results_preview);
            }

            // Rank changes (for re-ranking and time boost stages)
            if (stage.metadata && stage.metadata.rank_changes && stage.metadata.rank_changes.length > 0) {
                html += renderRankChanges(stage.metadata.rank_changes);
            }

            // Removed items (for filtering stages)
            if (stage.metadata && stage.metadata.removed_items && stage.metadata.removed_items.length > 0) {
                html += renderRemovedItems(stage.metadata.removed_items, stage.stage_num);
            }

            html += '</div></div>';

            return html;
        }

        // Render stage metadata
        function renderStageMetadata(stage) {
            const metadata = stage.metadata;
            if (!metadata) return '';

            let html = '<div class="stage-metadata">';

            // Stage-specific metadata rendering
            if (stage.stage_num === 0) {
                // Query expansion
                html += `
                    <div class="metadata-row">
                        <span class="metadata-label">Applied:</span>
                        <span class="metadata-value">${metadata.applied ? 'Yes' : 'No'}</span>
                    </div>
                `;
                if (metadata.applied) {
                    html += `
                        <div class="metadata-row">
                            <span class="metadata-label">Original Query:</span>
                            <span class="metadata-value">${metadata.original_query}</span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Expanded Query:</span>
                            <span class="metadata-value">${metadata.expanded_query}</span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Expansion Terms:</span>
                            <span class="metadata-value">${metadata.expansion_terms.join(', ')}</span>
                        </div>
                    `;
                }
            } else if (stage.stage_num === 1) {
                // Primary retrieval
                html += `
                    <div class="metadata-row">
                        <span class="metadata-label">Search Mode:</span>
                        <span class="metadata-value">${metadata.search_mode}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Search Limit:</span>
                        <span class="metadata-value">${metadata.search_limit}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Note:</span>
                        <span class="metadata-value">${metadata.note}</span>
                    </div>
                `;
            } else if (stage.stage_num === 3) {
                // Score filtering
                html += `
                    <div class="metadata-row">
                        <span class="metadata-label">Applied:</span>
                        <span class="metadata-value">${metadata.applied ? 'Yes (semantic mode)' : 'No (hybrid mode)'}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Before ‚Üí After:</span>
                        <span class="metadata-value">${metadata.before_count} ‚Üí ${metadata.after_count}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Removed:</span>
                        <span class="metadata-value">${metadata.removed_count}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Min Score:</span>
                        <span class="metadata-value">${metadata.min_score_threshold}</span>
                    </div>
                `;
            } else if (stage.stage_num === 4 || stage.stage_num === 5) {
                // Status/type filtering
                html += `
                    <div class="metadata-row">
                        <span class="metadata-label">Before ‚Üí After:</span>
                        <span class="metadata-value">${metadata.before_count} ‚Üí ${metadata.after_count}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Removed:</span>
                        <span class="metadata-value">${metadata.removed_count}</span>
                    </div>
                `;
                if (stage.stage_num === 5) {
                    if (metadata.include_types && metadata.include_types.length > 0) {
                        html += `
                            <div class="metadata-row">
                                <span class="metadata-label">Include Types:</span>
                                <span class="metadata-value">${metadata.include_types.join(', ')}</span>
                            </div>
                        `;
                    }
                    if (metadata.exclude_types && metadata.exclude_types.length > 0) {
                        html += `
                            <div class="metadata-row">
                                <span class="metadata-label">Exclude Types:</span>
                                <span class="metadata-value">${metadata.exclude_types.join(', ')}</span>
                            </div>
                        `;
                    }
                }
            } else if (stage.stage_num === 6) {
                // Re-ranking
                html += `
                    <div class="metadata-row">
                        <span class="metadata-label">Applied:</span>
                        <span class="metadata-value">${metadata.applied ? 'Yes' : 'No'}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Rerank Count:</span>
                        <span class="metadata-value">${metadata.rerank_count}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Total Rank Changes:</span>
                        <span class="metadata-value">${metadata.total_rank_changes}</span>
                    </div>
                `;
            } else if (stage.stage_num === 7) {
                // Time boost
                html += `
                    <div class="metadata-row">
                        <span class="metadata-label">Applied:</span>
                        <span class="metadata-value">${metadata.applied ? 'Yes' : 'No'}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Boosted Count:</span>
                        <span class="metadata-value">${metadata.boosted_count}</span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Total Rank Changes:</span>
                        <span class="metadata-value">${metadata.total_rank_changes}</span>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // Render results preview
        function renderResultsPreview(results) {
            let html = '<div class="results-preview"><div class="preview-header">Top Results</div>';

            results.forEach((result, idx) => {
                html += `
                    <div class="result-item">
                        <div class="result-path">${idx + 1}. ${result.title || result.relative_path}</div>
                        <div class="result-scores">
                `;

                if (result.similarity_score !== undefined) {
                    html += `<span class="score-badge">sem: ${result.similarity_score}</span>`;
                }
                if (result.bm25_score !== undefined) {
                    html += `<span class="score-badge">bm25: ${result.bm25_score}</span>`;
                }
                if (result.rrf_score !== undefined) {
                    html += `<span class="score-badge">rrf: ${result.rrf_score}</span>`;
                }
                if (result.cross_encoder_score !== undefined) {
                    html += `<span class="score-badge">ce: ${result.cross_encoder_score}</span>`;
                }
                if (result.time_boost !== undefined && result.time_boost > 0) {
                    html += `<span class="score-badge">time: +${result.time_boost}</span>`;
                }
                if (result.tag_boosted) {
                    html += `<span class="score-badge highlight">tag-boosted</span>`;
                }
                if (result.tags_matched && result.tags_matched.length > 0) {
                    html += `<span class="score-badge highlight">tags: ${result.tags_matched.join(', ')}</span>`;
                }

                html += '</div></div>';
            });

            html += '</div>';
            return html;
        }

        // Render rank changes
        function renderRankChanges(changes) {
            if (!changes || changes.length === 0) return '';

            let html = '<div class="results-preview"><div class="preview-header">Rank Changes</div>';

            changes.forEach(change => {
                const direction = change.delta > 0 ? 'up' : 'down';
                const arrow = change.delta > 0 ? '‚Üë' : '‚Üì';
                const displayDelta = Math.abs(change.delta);

                html += `
                    <div class="rank-change">
                        <div class="rank-change-path">${change.title || change.relative_path}</div>
                        <div class="rank-change-delta ${direction}">#${change.before_rank} ‚Üí #${change.after_rank} (${arrow}${displayDelta})</div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // Render removed items
        function renderRemovedItems(items, stageNum) {
            if (!items || items.length === 0) return '';

            let html = '<div class="results-preview"><div class="preview-header">Removed Items</div>';

            items.forEach(item => {
                let details = '';
                if (stageNum === 3 && item.similarity_score !== undefined) {
                    details = `(score: ${item.similarity_score})`;
                } else if (stageNum === 4 && item.status) {
                    details = `(status: ${item.status})`;
                } else if (stageNum === 5 && item.type) {
                    details = `(type: ${item.type})`;
                }

                html += `
                    <div class="result-item">
                        <div class="result-path">${item.relative_path} ${details}</div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // Toggle stage expansion
        function toggleStage(idx) {
            const content = document.getElementById(`stage-${idx}`);
            const arrow = document.getElementById(`arrow-${idx}`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                arrow.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                arrow.classList.add('expanded');
            }
        }

        // Clear results
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('exportBtn').style.display = 'none';
            currentPipelineData = null;
        }

        // Export pipeline to JSON
        function exportPipeline() {
            if (!currentPipelineData) {
                alert('No pipeline data to export');
                return;
            }

            const dataStr = JSON.stringify(currentPipelineData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pipeline-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.activeElement.id === 'query') {
                e.preventDefault();
                runPipeline();
            }
        });

        // Initialize
        loadVaults();
    </script>
</body>
</html>
