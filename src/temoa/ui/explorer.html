<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorer - Temoa</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #1a1a1a;
            line-height: 1.5;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            background: #1a1a1a;
            border-bottom: 1px solid #333333;
            padding: 12px 16px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .nav-links {
            display: flex;
            gap: 12px;
        }

        .nav-link {
            color: #888888;
            text-decoration: none;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        /* Search controls row */
        .search-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 14px;
            font-size: 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
        }

        .search-input:focus {
            border-color: #666666;
        }

        .vault-select,
        .profile-select {
            padding: 10px 14px;
            font-size: 14px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
            cursor: pointer;
            min-width: 140px;
        }

        .vault-select:focus,
        .profile-select:focus {
            border-color: #666666;
        }

        .run-btn {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            background: #4a6a8a;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .run-btn:hover {
            background: #5a7a9a;
        }

        .run-btn:active {
            background: #3a5a7a;
        }

        .run-btn:disabled {
            background: #333333;
            color: #666666;
            cursor: not-allowed;
        }

        /* Three-pane layout */
        .explorer-container {
            height: calc(100vh - 110px);
            overflow: hidden;
        }

        .explorer-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 16px;
            padding: 16px;
            height: 100%;
        }

        .pane {
            background: #222222;
            border: 1px solid #333333;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pane-header {
            padding: 12px 16px;
            border-bottom: 1px solid #333333;
            font-size: 14px;
            font-weight: 500;
            color: #aaaaaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pane-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Scrollbar styles */
        .pane-content::-webkit-scrollbar {
            width: 8px;
        }

        .pane-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .pane-content::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .pane-content::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* Empty states */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666666;
            text-align: center;
            padding: 32px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Responsive breakpoints */
        @media (max-width: 1024px) {
            .explorer-grid {
                grid-template-columns: 240px 1fr 280px;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 12px;
            }

            .header-top {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .nav-links {
                justify-content: flex-end;
            }

            .search-controls {
                flex-direction: column;
                gap: 8px;
            }

            .vault-select,
            .profile-select {
                width: 100%;
            }

            .explorer-container {
                height: calc(100vh - 180px);
            }

            .explorer-grid {
                grid-template-columns: 1fr;
                padding: 12px;
                gap: 12px;
            }

            .pane {
                min-height: 300px;
            }

            /* Mobile: Controls accordion (collapsed by default) */
            #controls-pane {
                max-height: 48px;
                transition: max-height 0.3s ease;
            }

            #controls-pane.expanded {
                max-height: 600px;
            }

            .pane-header {
                cursor: pointer;
                user-select: none;
            }

            .pane-header::after {
                content: '‚ñº';
                float: right;
                font-size: 12px;
                transition: transform 0.3s;
            }

            #controls-pane.expanded .pane-header::after {
                transform: rotate(180deg);
            }

            /* Mobile: Inspector as drawer */
            #inspector-pane {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 70vh;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 100;
                border-radius: 12px 12px 0 0;
            }

            #inspector-pane.visible {
                transform: translateY(0);
            }
        }

        /* Mixer controls */
        .mixer-section {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .mixer-section h3 {
            font-size: 12px;
            font-weight: 500;
            color: #aaaaaa;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mixer-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .mixer-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .mixer-item label {
            font-size: 11px;
            color: #888888;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mixer-item input[type="number"] {
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            outline: none;
            width: 100%;
        }

        .mixer-item input[type="number"]:focus {
            border-color: #666666;
        }

        /* Tooltips */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3a3a3a;
            color: #888888;
            font-size: 9px;
            font-weight: 600;
            cursor: help;
            flex-shrink: 0;
        }

        .tooltip-wrapper {
            position: relative;
            display: inline-flex;
        }

        .tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #333333;
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            color: #d0d0d0;
            white-space: normal;
            width: 200px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            text-transform: none;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #4a4a4a;
        }

        .tooltip-wrapper:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Balance slider */
        .balance-slider {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .balance-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: #888888;
        }

        .balance-labels > span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .balance-value {
            font-size: 9px;
            color: #666666;
        }

        .balance-track {
            position: relative;
            height: 6px;
            background: linear-gradient(to right, #4a6a8a, #8a6a4a);
            border-radius: 3px;
        }

        .balance-input {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 100%;
            height: 18px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            margin: 0;
        }

        .balance-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 2px solid #1a1a1a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .balance-input::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 2px solid #1a1a1a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        /* Checkbox items */
        .checkbox-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 12px;
            color: #c0c0c0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Fetch dirty indicator */
        .server-section {
            border-color: #333333;
        }

        .server-section.dirty {
            border-color: #665500;
        }

        .refetch-notice {
            display: none;
            font-size: 11px;
            color: #cc8800;
            margin-top: 10px;
            padding: 6px 10px;
            background: rgba(204, 136, 0, 0.1);
            border-radius: 4px;
        }

        .server-section.dirty .refetch-notice {
            display: block;
        }

        /* Action buttons */
        .action-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }

        .action-btn {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #2a2a2a;
            color: #c0c0c0;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }

        .action-btn:hover {
            background: #333333;
            border-color: #4a4a4a;
        }

        .action-btn:active {
            background: #1a1a1a;
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            color: #888888;
            font-size: 14px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #333333;
            border-top-color: #888888;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide on mobile (desktop-only elements) */
        @media (max-width: 768px) {
            .desktop-only {
                display: none !important;
            }
        }

        /* Hide on desktop (mobile-only elements) */
        @media (min-width: 769px) {
            .mobile-only {
                display: none !important;
            }
        }

        /* Results list styles */
        .results-table {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-row {
            background: #1a1a1a;
            padding: 12px 14px;
            border-radius: 6px;
            border: 1px solid #333333;
            transition: all 0.2s;
            cursor: pointer;
        }

        .result-row:hover {
            background: #252525;
            border-color: #404040;
        }

        .result-row.selected {
            border-color: #4a6a8a;
            background: #1a2a3a;
        }

        .result-title-link {
            font-weight: 600;
            color: #c0c0c0;
            text-decoration: none;
            font-size: 14px;
            line-height: 1.3;
            display: block;
            margin-bottom: 4px;
        }

        .result-title-link:hover {
            color: #e0e0e0;
            text-decoration: underline;
        }

        .result-path {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #666666;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .result-dates {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #666666;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .result-description {
            color: #999999;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 6px;
        }

        .tag {
            background: #2a2a2a;
            color: #888888;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            border: 1px solid #333333;
        }

        .result-scores-compact {
            font-size: 9px;
            color: #555555;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .type-badge,
        .project-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #2a2a2a;
            color: #888888;
            border: 1px solid #333333;
            text-decoration: none;
            white-space: nowrap;
        }

        .type-badge {
            background: #2a3a2a;
            color: #88aa88;
            border-color: #3a4a3a;
        }

        .project-badge {
            background: #2a2a3a;
            color: #8888aa;
            border-color: #3a3a4a;
        }

        .project-badge:hover {
            background: #3a3a4a;
            color: #aaaacc;
        }

        /* Inspector pane styles */
        .inspector-section {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .inspector-section h3 {
            font-size: 11px;
            font-weight: 600;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .inspector-title {
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .inspector-path {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 10px;
            color: #666666;
            margin-bottom: 10px;
        }

        .inspector-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 4px 0;
            font-size: 11px;
            border-bottom: 1px solid #252525;
        }

        .inspector-row:last-child {
            border-bottom: none;
        }

        .inspector-label {
            color: #777777;
            flex-shrink: 0;
            margin-right: 8px;
            min-width: 80px;
        }

        .inspector-value {
            color: #b0b0b0;
            text-align: right;
            word-break: break-word;
        }

        .inspector-value.mono {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 10px;
        }

        .inspector-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .inspector-tag {
            background: #2a2a2a;
            color: #888888;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            border: 1px solid #333333;
        }

        .score-bar {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            color: #c0c0c0;
            min-width: 50px;
            text-align: right;
        }

        .score-visual {
            flex: 1;
            height: 4px;
            background: #2a2a2a;
            border-radius: 2px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a6a8a, #6a8aaa);
            transition: width 0.3s ease;
        }

        .inspector-link {
            display: inline-block;
            color: #6a8aaa;
            text-decoration: none;
            font-size: 11px;
            padding: 4px 8px;
            border: 1px solid #3a4a5a;
            border-radius: 4px;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .inspector-link:hover {
            background: #2a3a4a;
            border-color: #4a6a8a;
            color: #8aaacc;
        }

        .close-inspector {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a2a2a;
            border: 1px solid #333333;
            border-radius: 4px;
            color: #888888;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s;
        }

        .close-inspector:hover {
            background: #333333;
            color: #c0c0c0;
        }

        @media (max-width: 768px) {
            .close-inspector {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .close-inspector {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <h1>Explorer</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">Search</a>
                <a href="/harness" class="nav-link">Harness</a>
                <a href="/pipeline" class="nav-link">Pipeline</a>
                <a href="/manage" class="nav-link">Manage</a>
            </div>
        </div>
        <div class="search-controls">
            <div class="search-input-wrapper">
                <input type="text" id="query-input" class="search-input" placeholder="Search your vault..." autocomplete="off">
            </div>
            <select id="vault-select" class="vault-select">
                <option value="">Loading vaults...</option>
            </select>
            <select id="profile-select" class="profile-select">
                <option value="">Default</option>
            </select>
            <button id="run-btn" class="run-btn">Run</button>
        </div>
    </header>

    <div class="explorer-container">
        <div class="explorer-grid">
            <!-- Left Pane: Controls (Mixer) -->
            <div id="controls-pane" class="pane">
                <div class="pane-header">Controls</div>
                <div class="pane-content">
                    <!-- Fetch params (server round-trip required) -->
                    <div class="mixer-section server-section" id="fetch-section">
                        <h3>
                            Fetch
                            <span class="tooltip-wrapper">
                                <span class="info-icon">?</span>
                                <span class="tooltip">Controls WHICH documents are retrieved. Changes require clicking Run.</span>
                            </span>
                        </h3>

                        <!-- Hybrid balance slider -->
                        <div class="balance-slider" style="margin-bottom: 10px;">
                            <div class="balance-labels">
                                <span>
                                    Sem
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Conceptual similarity via embeddings.</span>
                                    </span>
                                </span>
                                <span class="balance-value" id="fetch-balance-value">50/50</span>
                                <span>
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Keyword matching (BM25).</span>
                                    </span>
                                    BM25
                                </span>
                            </div>
                            <div class="balance-track">
                                <input type="range" id="fetch-hybrid" class="balance-input" min="0" max="100" value="50">
                            </div>
                        </div>

                        <div class="mixer-grid">
                            <div class="mixer-item">
                                <label>
                                    Result Limit
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Maximum number of results to return.</span>
                                    </span>
                                </label>
                                <input type="number" id="fetch-limit" value="20" step="5" min="5" max="100">
                            </div>
                        </div>

                        <div class="checkbox-grid" style="margin-top: 10px;">
                            <div class="checkbox-item">
                                <input type="checkbox" id="fetch-rerank" checked>
                                <label for="fetch-rerank">
                                    Cross-encoder
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Better precision, slower (~200ms).</span>
                                    </span>
                                </label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="fetch-expand">
                                <label for="fetch-expand">
                                    Expand query
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Add related terms to short queries.</span>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="refetch-notice">
                            Fetch parameters changed. Click "Run" to apply.
                        </div>
                    </div>

                    <!-- Live params (client-side, instant) -->
                    <div class="mixer-section" id="live-section">
                        <h3>
                            Live
                            <span class="tooltip-wrapper">
                                <span class="info-icon">?</span>
                                <span class="tooltip">Re-rank retrieved results instantly. No server call needed.</span>
                            </span>
                        </h3>

                        <!-- Semantic/BM25 balance slider -->
                        <div class="balance-slider" style="margin-bottom: 10px;">
                            <div class="balance-labels">
                                <span>
                                    Sem
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Weight semantic scores higher.</span>
                                    </span>
                                </span>
                                <span class="balance-value" id="live-balance-value">50/50</span>
                                <span>
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Weight BM25 scores higher.</span>
                                    </span>
                                    BM25
                                </span>
                            </div>
                            <div class="balance-track">
                                <input type="range" id="live-balance" class="balance-input" min="0" max="100" value="50">
                            </div>
                        </div>

                        <div class="mixer-grid">
                            <div class="mixer-item">
                                <label>
                                    Tag Multiplier
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Score multiplier for tag-matched results (0-10).</span>
                                    </span>
                                </label>
                                <input type="number" id="live-tags" value="5.0" step="0.5" min="0" max="10">
                            </div>

                            <div class="mixer-item">
                                <label>
                                    Time Weight
                                    <span class="tooltip-wrapper">
                                        <span class="info-icon">?</span>
                                        <span class="tooltip">Multiplier on recency boost (0-2).</span>
                                    </span>
                                </label>
                                <input type="number" id="live-time" value="1.0" step="0.1" min="0" max="2">
                            </div>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="action-row">
                        <button id="reset-mix-btn" class="action-btn">Reset Mix</button>
                        <button id="save-profile-btn" class="action-btn">Save Profile...</button>
                        <button id="export-btn" class="action-btn">Export JSON</button>
                    </div>
                </div>
            </div>

            <!-- Center Pane: Results -->
            <div id="results-pane" class="pane">
                <div class="pane-header">
                    Results
                    <span id="result-count" style="color: #666666; font-weight: normal; text-transform: none; margin-left: 8px;"></span>
                </div>
                <div class="pane-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">
                            Enter a query and click Run<br>to see results
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Pane: Inspector -->
            <div id="inspector-pane" class="pane">
                <div class="pane-header">Inspector</div>
                <div class="pane-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">
                            Select a result<br>to inspect details
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // State Management
        // ========================================

        const STORAGE_KEY = 'temoa_state'
        const EXPLORER_STORAGE_KEY = 'temoa_explorer_state'

        const explorerState = {
            // Search state
            query: '',
            vault: null,
            profile: null,
            vaults: [],
            profiles: [],

            // Results
            rawResults: [],        // From server (with harness data)
            remixedResults: [],    // After client-side remix
            pipelineData: null,    // Pipeline stages (if pipeline_debug=true)

            // UI state
            viewMode: 'list',      // 'list' | 'pipeline'
            selectedResult: null,  // Currently inspected result
            selectedStage: null,   // If viewing pipeline

            // Mixer state (fetch params - trigger new search)
            fetchParams: {
                hybrid_weight: 0.5,    // 0=semantic, 1=BM25
                limit: 20,
                rerank: true,
                expand: false
            },

            // Mixer state (live params - client-side remix)
            liveParams: {
                mix_balance: 0.5,      // 0=semantic, 1=BM25
                tag_multiplier: 5.0,
                time_weight: 1.0
            },

            // Persistence
            searchHistory: [],
            fetchParamsChanged: false,
            lastFetchParams: null
        }

        // ========================================
        // State Persistence
        // ========================================

        function saveExplorerState() {
            try {
                const data = {
                    viewMode: explorerState.viewMode,
                    fetchParams: explorerState.fetchParams,
                    liveParams: explorerState.liveParams,
                    vault: explorerState.vault,
                    profile: explorerState.profile
                }
                localStorage.setItem(EXPLORER_STORAGE_KEY, JSON.stringify(data))
            } catch (err) {
                console.error('Failed to save explorer state:', err)
            }
        }

        function restoreExplorerState() {
            try {
                const saved = localStorage.getItem(EXPLORER_STORAGE_KEY)
                if (saved) {
                    const data = JSON.parse(saved)

                    // Restore view mode
                    if (data.viewMode) {
                        explorerState.viewMode = data.viewMode
                    }

                    // Restore fetch params
                    if (data.fetchParams) {
                        explorerState.fetchParams = { ...explorerState.fetchParams, ...data.fetchParams }
                    }

                    // Restore live params
                    if (data.liveParams) {
                        explorerState.liveParams = { ...explorerState.liveParams, ...data.liveParams }
                    }

                    // Vault and profile restored from selectors
                }
            } catch (err) {
                console.error('Failed to restore explorer state:', err)
            }
        }

        function saveSearchHistory() {
            try {
                const sharedState = localStorage.getItem(STORAGE_KEY)
                let data = sharedState ? JSON.parse(sharedState) : {}
                data.searchHistory = explorerState.searchHistory
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
            } catch (err) {
                console.error('Failed to save search history:', err)
            }
        }

        function restoreSearchHistory() {
            try {
                const sharedState = localStorage.getItem(STORAGE_KEY)
                if (sharedState) {
                    const data = JSON.parse(sharedState)
                    if (data.searchHistory) {
                        explorerState.searchHistory = data.searchHistory
                    }
                }
            } catch (err) {
                console.error('Failed to restore search history:', err)
            }
        }

        function addToSearchHistory(query) {
            const trimmedQuery = query.trim()
            if (!trimmedQuery) return

            // Remove if already exists
            explorerState.searchHistory = explorerState.searchHistory.filter(q => q !== trimmedQuery)

            // Add to front
            explorerState.searchHistory.unshift(trimmedQuery)

            // Keep only last 10
            if (explorerState.searchHistory.length > 10) {
                explorerState.searchHistory = explorerState.searchHistory.slice(0, 10)
            }

            saveSearchHistory()
        }

        // ========================================
        // DOM Elements
        // ========================================

        const queryInput = document.getElementById('query-input')
        const vaultSelect = document.getElementById('vault-select')
        const profileSelect = document.getElementById('profile-select')
        const runBtn = document.getElementById('run-btn')

        const controlsPane = document.getElementById('controls-pane')
        const resultsPane = document.getElementById('results-pane')
        const inspectorPane = document.getElementById('inspector-pane')

        const controlsContent = controlsPane.querySelector('.pane-content')
        const resultsContent = resultsPane.querySelector('.pane-content')
        const inspectorContent = inspectorPane.querySelector('.pane-content')

        const resultCount = document.getElementById('result-count')

        // Fetch controls
        const fetchSection = document.getElementById('fetch-section')
        const fetchHybrid = document.getElementById('fetch-hybrid')
        const fetchBalanceValue = document.getElementById('fetch-balance-value')
        const fetchLimit = document.getElementById('fetch-limit')
        const fetchRerank = document.getElementById('fetch-rerank')
        const fetchExpand = document.getElementById('fetch-expand')

        // Live controls
        const liveBalance = document.getElementById('live-balance')
        const liveBalanceValue = document.getElementById('live-balance-value')
        const liveTags = document.getElementById('live-tags')
        const liveTime = document.getElementById('live-time')

        // Action buttons
        const resetMixBtn = document.getElementById('reset-mix-btn')
        const saveProfileBtn = document.getElementById('save-profile-btn')
        const exportBtn = document.getElementById('export-btn')

        // ========================================
        // Initialization
        // ========================================

        async function initialize() {
            // Restore state from localStorage
            restoreExplorerState()
            restoreSearchHistory()

            // Load vaults
            await loadVaults()

            // Load profiles
            await loadProfiles()

            // Sync UI with restored state
            syncUIWithState()

            // Wire up event handlers
            setupEventHandlers()

            // Mobile accordion
            setupMobileAccordion()

            console.log('Explorer initialized', explorerState)
        }

        function syncUIWithState() {
            // Fetch controls
            const fetchWeight = Math.round(explorerState.fetchParams.hybrid_weight * 100)
            fetchHybrid.value = fetchWeight
            fetchBalanceValue.textContent = `${100-fetchWeight}/${fetchWeight}`
            fetchLimit.value = explorerState.fetchParams.limit
            fetchRerank.checked = explorerState.fetchParams.rerank
            fetchExpand.checked = explorerState.fetchParams.expand

            // Live controls
            const liveWeight = Math.round(explorerState.liveParams.mix_balance * 100)
            liveBalance.value = liveWeight
            liveBalanceValue.textContent = `${100-liveWeight}/${liveWeight}`
            liveTags.value = explorerState.liveParams.tag_multiplier
            liveTime.value = explorerState.liveParams.time_weight
        }

        async function loadVaults() {
            try {
                const res = await fetch('/vaults')
                const data = await res.json()
                explorerState.vaults = data.vaults || []

                vaultSelect.innerHTML = explorerState.vaults.map(v =>
                    `<option value="${v.name}" ${v.is_default ? 'selected' : ''}>${v.name}${v.is_default ? ' (default)' : ''}</option>`
                ).join('')

                const defaultVault = explorerState.vaults.find(v => v.is_default)
                explorerState.vault = defaultVault?.name || explorerState.vaults[0]?.name
            } catch (err) {
                console.error('Failed to load vaults:', err)
                vaultSelect.innerHTML = '<option value="">Error loading vaults</option>'
            }
        }

        async function loadProfiles() {
            try {
                const res = await fetch('/profiles')
                const data = await res.json()
                explorerState.profiles = data.profiles || []

                profileSelect.innerHTML = '<option value="">default</option>' +
                    explorerState.profiles.map(p =>
                        `<option value="${p.name}">${p.name}</option>`
                    ).join('')
            } catch (err) {
                console.error('Failed to load profiles:', err)
            }
        }

        function setupEventHandlers() {
            // Vault selector
            vaultSelect.addEventListener('change', () => {
                explorerState.vault = vaultSelect.value
                saveExplorerState()
            })

            // Profile selector
            profileSelect.addEventListener('change', () => {
                explorerState.profile = profileSelect.value || null
                saveExplorerState()
            })

            // Run button
            runBtn.addEventListener('click', runSearch)

            // Enter key in query input
            queryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    runSearch()
                }
            })

            // Fetch controls (mark as dirty when changed)
            fetchHybrid.addEventListener('input', () => {
                const val = parseInt(fetchHybrid.value)
                fetchBalanceValue.textContent = `${100-val}/${val}`
                explorerState.fetchParams.hybrid_weight = val / 100
                markFetchDirty()
                saveExplorerState()
            })

            fetchLimit.addEventListener('change', () => {
                explorerState.fetchParams.limit = parseInt(fetchLimit.value)
                markFetchDirty()
                saveExplorerState()
            })

            fetchRerank.addEventListener('change', () => {
                explorerState.fetchParams.rerank = fetchRerank.checked
                markFetchDirty()
                saveExplorerState()
            })

            fetchExpand.addEventListener('change', () => {
                explorerState.fetchParams.expand = fetchExpand.checked
                markFetchDirty()
                saveExplorerState()
            })

            // Live controls (instant remix when results exist)
            liveBalance.addEventListener('input', () => {
                const val = parseInt(liveBalance.value)
                liveBalanceValue.textContent = `${100-val}/${val}`
                explorerState.liveParams.mix_balance = val / 100
                if (explorerState.rawResults.length > 0) {
                    remixAndRender()
                }
                saveExplorerState()
            })

            liveTags.addEventListener('change', () => {
                explorerState.liveParams.tag_multiplier = parseFloat(liveTags.value)
                if (explorerState.rawResults.length > 0) {
                    remixAndRender()
                }
                saveExplorerState()
            })

            liveTime.addEventListener('change', () => {
                explorerState.liveParams.time_weight = parseFloat(liveTime.value)
                if (explorerState.rawResults.length > 0) {
                    remixAndRender()
                }
                saveExplorerState()
            })

            // Action buttons
            resetMixBtn.addEventListener('click', resetMix)
            saveProfileBtn.addEventListener('click', () => {
                alert('Profile saving not yet implemented (Phase 4)')
            })
            exportBtn.addEventListener('click', () => {
                alert('Export JSON not yet implemented (Phase 4)')
            })
        }

        function markFetchDirty() {
            if (explorerState.lastFetchParams) {
                const current = explorerState.fetchParams
                const last = explorerState.lastFetchParams
                const changed =
                    current.hybrid_weight !== last.hybrid_weight ||
                    current.limit !== last.limit ||
                    current.rerank !== last.rerank ||
                    current.expand !== last.expand

                if (changed) {
                    fetchSection.classList.add('dirty')
                    explorerState.fetchParamsChanged = true
                } else {
                    fetchSection.classList.remove('dirty')
                    explorerState.fetchParamsChanged = false
                }
            }
        }

        function resetMix() {
            // Reset to defaults
            explorerState.liveParams = {
                mix_balance: 0.5,
                tag_multiplier: 5.0,
                time_weight: 1.0
            }

            // Update UI
            liveBalance.value = 50
            liveBalanceValue.textContent = '50/50'
            liveTags.value = 5.0
            liveTime.value = 1.0

            // Remix if results exist
            if (explorerState.rawResults.length > 0) {
                remixAndRender()
            }

            saveExplorerState()
        }

        function remixAndRender() {
            // Client-side remix: re-blend semantic/BM25, apply tag/time multipliers
            if (!explorerState.rawResults || explorerState.rawResults.length === 0) return

            const { mix_balance, tag_multiplier, time_weight } = explorerState.liveParams

            // Clone and re-score
            const remixed = explorerState.rawResults.map(r => {
                const clone = { ...r }

                // Re-blend semantic + BM25 scores
                const semanticScore = clone.similarity_score || 0
                const bm25Score = clone.bm25_score || 0

                // Normalize BM25 to 0-1 range (assuming max ~10)
                const normalizedBM25 = Math.min(bm25Score / 10, 1)

                // Mix: 0 = all semantic, 1 = all BM25
                let mixedScore = (1 - mix_balance) * semanticScore + mix_balance * normalizedBM25

                // Apply tag multiplier if tag boosted
                if (clone.tag_boosted) {
                    mixedScore *= tag_multiplier
                }

                // Apply time boost
                if (clone.time_boost && time_weight > 0) {
                    mixedScore *= (1 + clone.time_boost * time_weight)
                }

                clone.final_score = mixedScore
                return clone
            })

            // Sort by final score descending
            remixed.sort((a, b) => b.final_score - a.final_score)

            explorerState.remixedResults = remixed
            renderResults()
        }

        function setupMobileAccordion() {
            if (window.innerWidth <= 768) {
                const controlsHeader = controlsPane.querySelector('.pane-header')
                controlsHeader.addEventListener('click', () => {
                    controlsPane.classList.toggle('expanded')
                })
            }
        }

        // ========================================
        // Search Flow
        // ========================================

        async function runSearch() {
            const query = queryInput.value.trim()
            if (!query) return

            // Clear any previous error
            hideError()

            // Show loading state
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><span>Searching...</span></div>'

            // Disable run button
            runBtn.disabled = true

            try {
                // Build search URL with fetch params
                const params = new URLSearchParams({
                    q: query,
                    vault: explorerState.vault || '',
                    limit: explorerState.fetchParams.limit,
                    hybrid_weight: explorerState.fetchParams.hybrid_weight,
                    rerank: explorerState.fetchParams.rerank,
                    expand: explorerState.fetchParams.expand,
                    harness: 'true'  // Request harness data (all pipeline stages)
                })

                if (explorerState.profile) {
                    params.set('profile', explorerState.profile)
                }

                const response = await fetch(`/search?${params}`)
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.statusText}`)
                }

                const data = await response.json()

                // Store raw results with harness data
                explorerState.rawResults = data.results || []
                explorerState.pipelineData = data.pipeline_stages || null
                explorerState.query = query

                // Mark fetch params as clean
                explorerState.lastFetchParams = { ...explorerState.fetchParams }
                fetchSection.classList.remove('dirty')
                explorerState.fetchParamsChanged = false

                // Add to search history
                addToSearchHistory(query)

                // Initial render (applies live params)
                remixAndRender()

                // Update result count
                resultCount.textContent = `(${explorerState.rawResults.length})`

            } catch (err) {
                console.error('Search error:', err)
                showError(`Search failed: ${err.message}`)
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Search failed<br>${err.message}</div>
                    </div>
                `
            } finally {
                runBtn.disabled = false
            }
        }

        function renderResults() {
            const results = explorerState.remixedResults.length > 0
                ? explorerState.remixedResults
                : explorerState.rawResults

            if (!results || results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">
                            No results found for<br>"${explorerState.query}"
                        </div>
                    </div>
                `
                return
            }

            // Create results table
            const table = document.createElement('div')
            table.className = 'results-table'

            results.forEach(result => {
                const card = createResultCard(result)
                table.appendChild(card)
            })

            resultsContent.replaceChildren(table)
        }

        function createResultCard(result) {
            const card = document.createElement('div')
            card.className = 'result-row'
            card.dataset.resultId = result.relative_path

            // Click handler for inspector
            card.addEventListener('click', () => {
                selectResult(result)
            })

            // Title row with badges
            const titleRow = document.createElement('div')
            titleRow.style.display = 'flex'
            titleRow.style.justifyContent = 'space-between'
            titleRow.style.alignItems = 'flex-start'
            titleRow.style.gap = '8px'
            titleRow.style.marginBottom = '4px'

            const titleLink = document.createElement('a')
            titleLink.className = 'result-title-link'
            titleLink.href = result.obsidian_uri
            titleLink.textContent = result.title || result.relative_path
            titleLink.addEventListener('click', (e) => {
                e.stopPropagation()  // Don't trigger card click
            })
            titleRow.appendChild(titleLink)

            // Badges
            const badgesDiv = document.createElement('div')
            badgesDiv.style.display = 'flex'
            badgesDiv.style.gap = '4px'
            badgesDiv.style.flexShrink = '0'

            if (result.frontmatter?.type) {
                const type = Array.isArray(result.frontmatter.type)
                    ? result.frontmatter.type.join(', ')
                    : String(result.frontmatter.type)
                const badge = document.createElement('span')
                badge.className = 'type-badge'
                badge.textContent = type
                badgesDiv.appendChild(badge)
            }

            if (result.frontmatter?.project) {
                const vaultName = result.obsidian_uri.split('/')[3]
                let project = result.frontmatter.project
                if (Array.isArray(project)) project = project[0]
                const projectName = String(project).replace(/[\[\]]/g, '')
                const projectUri = `obsidian://vault/${vaultName}/${encodeURIComponent(projectName)}`
                const badge = document.createElement('a')
                badge.className = 'project-badge'
                badge.textContent = projectName
                badge.href = projectUri
                badge.addEventListener('click', (e) => {
                    e.stopPropagation()
                })
                badgesDiv.appendChild(badge)
            }

            if (badgesDiv.children.length > 0) {
                titleRow.appendChild(badgesDiv)
            }

            card.appendChild(titleRow)

            // Path
            const pathDiv = document.createElement('div')
            pathDiv.className = 'result-path'
            pathDiv.textContent = result.relative_path
            card.appendChild(pathDiv)

            // Dates
            if (result.frontmatter?.created || result.frontmatter?.modified) {
                const datesDiv = document.createElement('div')
                datesDiv.className = 'result-dates'
                const dateParts = []
                if (result.frontmatter.created) {
                    dateParts.push(`Created: ${formatDate(result.frontmatter.created)}`)
                }
                if (result.frontmatter.modified) {
                    dateParts.push(`Modified: ${formatDate(result.frontmatter.modified)}`)
                }
                datesDiv.textContent = dateParts.join('  ‚Ä¢  ')
                card.appendChild(datesDiv)
            }

            // Description
            if (result.description) {
                const desc = document.createElement('div')
                desc.className = 'result-description'
                desc.textContent = result.description
                card.appendChild(desc)
            }

            // Tags
            if (result.tags && result.tags.length > 0) {
                const tagsDiv = document.createElement('div')
                tagsDiv.className = 'result-tags'
                result.tags.slice(0, 5).forEach(tag => {
                    const tagSpan = document.createElement('span')
                    tagSpan.className = 'tag'
                    tagSpan.textContent = `#${tag}`
                    tagsDiv.appendChild(tagSpan)
                })
                if (result.tags.length > 5) {
                    const more = document.createElement('span')
                    more.className = 'tag'
                    more.textContent = `+${result.tags.length - 5} more`
                    tagsDiv.appendChild(more)
                }
                card.appendChild(tagsDiv)
            }

            // Scores
            const scoresDiv = document.createElement('div')
            scoresDiv.className = 'result-scores-compact'
            const scoreParts = []

            if (result.similarity_score !== undefined) {
                scoreParts.push(`${(result.similarity_score * 100).toFixed(1)}% sem`)
            }
            if (result.bm25_score !== undefined) {
                scoreParts.push(`${result.bm25_score.toFixed(1)} bm25`)
            }
            if (result.rrf_score !== undefined) {
                scoreParts.push(`${result.rrf_score.toFixed(4)} rrf`)
            }
            if (result.cross_encoder_score !== undefined) {
                scoreParts.push(`${result.cross_encoder_score.toFixed(3)} xe`)
            }
            if (result.tag_boosted) {
                scoreParts.push('tag‚ö°')
            }
            if (result.time_boost !== undefined && result.time_boost > 0) {
                scoreParts.push(`time+${(result.time_boost * 100).toFixed(0)}%`)
            }
            if (result.final_score !== undefined) {
                scoreParts.push(`final=${result.final_score.toFixed(3)}`)
            }

            scoresDiv.textContent = scoreParts.join(' | ')
            card.appendChild(scoresDiv)

            return card
        }

        function selectResult(result) {
            // Update selected state
            explorerState.selectedResult = result

            // Visual feedback
            const cards = document.querySelectorAll('.result-row')
            cards.forEach(c => c.classList.remove('selected'))
            const selectedCard = document.querySelector(`[data-result-id="${result.relative_path}"]`)
            if (selectedCard) {
                selectedCard.classList.add('selected')
            }

            // Update inspector (will implement in Task #5)
            renderInspector(result)

            // Mobile: show inspector drawer
            if (window.innerWidth <= 768) {
                inspectorPane.classList.add('visible')
            }
        }

        function renderInspector(result) {
            const container = document.createElement('div')
            container.style.position = 'relative'

            // Close button (mobile only)
            const closeBtn = document.createElement('div')
            closeBtn.className = 'close-inspector'
            closeBtn.innerHTML = '√ó'
            closeBtn.addEventListener('click', () => {
                inspectorPane.classList.remove('visible')
                const cards = document.querySelectorAll('.result-row')
                cards.forEach(c => c.classList.remove('selected'))
                explorerState.selectedResult = null
            })
            container.appendChild(closeBtn)

            // Title section
            const titleSection = document.createElement('div')
            titleSection.className = 'inspector-section'

            const title = document.createElement('div')
            title.className = 'inspector-title'
            title.textContent = result.title || result.relative_path
            titleSection.appendChild(title)

            const path = document.createElement('div')
            path.className = 'inspector-path'
            path.textContent = result.relative_path
            titleSection.appendChild(path)

            const link = document.createElement('a')
            link.className = 'inspector-link'
            link.href = result.obsidian_uri
            link.textContent = '‚Üó Open in Obsidian'
            titleSection.appendChild(link)

            container.appendChild(titleSection)

            // Scores section
            const scoresSection = document.createElement('div')
            scoresSection.className = 'inspector-section'

            const scoresTitle = document.createElement('h3')
            scoresTitle.textContent = 'Scores'
            scoresSection.appendChild(scoresTitle)

            // Semantic score
            if (result.similarity_score !== undefined) {
                scoresSection.appendChild(createScoreBar('Semantic', result.similarity_score, result.similarity_score))
            }

            // BM25 score (normalize to 0-1 for visual, assuming max ~10)
            if (result.bm25_score !== undefined) {
                const normalizedBM25 = Math.min(result.bm25_score / 10, 1)
                scoresSection.appendChild(createScoreBar('BM25', result.bm25_score.toFixed(2), normalizedBM25))
            }

            // RRF score
            if (result.rrf_score !== undefined) {
                scoresSection.appendChild(createScoreBar('RRF', result.rrf_score.toFixed(4), result.rrf_score))
            }

            // Cross-encoder score
            if (result.cross_encoder_score !== undefined) {
                // Cross-encoder is typically -1 to 1, normalize to 0-1
                const normalized = (result.cross_encoder_score + 1) / 2
                scoresSection.appendChild(createScoreBar('Cross-Enc', result.cross_encoder_score.toFixed(4), normalized))
            }

            // Tag boost indicator
            if (result.tag_boosted) {
                const row = document.createElement('div')
                row.className = 'inspector-row'
                const label = document.createElement('div')
                label.className = 'inspector-label'
                label.textContent = 'Tag Boosted'
                const value = document.createElement('div')
                value.className = 'inspector-value'
                value.textContent = '‚ö° Yes'
                value.style.color = '#cc8800'
                row.appendChild(label)
                row.appendChild(value)
                scoresSection.appendChild(row)
            }

            // Time boost
            if (result.time_boost !== undefined && result.time_boost > 0) {
                const row = document.createElement('div')
                row.className = 'inspector-row'
                const label = document.createElement('div')
                label.className = 'inspector-label'
                label.textContent = 'Time Boost'
                const value = document.createElement('div')
                value.className = 'inspector-value'
                value.textContent = `+${(result.time_boost * 100).toFixed(0)}%`
                value.style.color = '#88aa88'
                row.appendChild(label)
                row.appendChild(value)
                scoresSection.appendChild(row)
            }

            // Final score (if remixed)
            if (result.final_score !== undefined) {
                const maxFinal = Math.max(...explorerState.remixedResults.map(r => r.final_score || 0))
                const normalized = maxFinal > 0 ? result.final_score / maxFinal : 0
                scoresSection.appendChild(createScoreBar('Final', result.final_score.toFixed(4), normalized))
            }

            container.appendChild(scoresSection)

            // Metadata section
            if (result.frontmatter && Object.keys(result.frontmatter).length > 0) {
                const metaSection = document.createElement('div')
                metaSection.className = 'inspector-section'

                const metaTitle = document.createElement('h3')
                metaTitle.textContent = 'Metadata'
                metaSection.appendChild(metaTitle)

                // Dates
                if (result.frontmatter.created) {
                    metaSection.appendChild(createInspectorRow('Created', formatDate(result.frontmatter.created)))
                }
                if (result.frontmatter.modified) {
                    metaSection.appendChild(createInspectorRow('Modified', formatDate(result.frontmatter.modified)))
                }

                // Type
                if (result.frontmatter.type) {
                    const typeVal = Array.isArray(result.frontmatter.type)
                        ? result.frontmatter.type.join(', ')
                        : String(result.frontmatter.type)
                    metaSection.appendChild(createInspectorRow('Type', typeVal))
                }

                // Project
                if (result.frontmatter.project) {
                    let projectVal = result.frontmatter.project
                    if (Array.isArray(projectVal)) projectVal = projectVal.join(', ')
                    metaSection.appendChild(createInspectorRow('Project', String(projectVal)))
                }

                // Status (for gleanings)
                if (result.frontmatter.status) {
                    metaSection.appendChild(createInspectorRow('Status', result.frontmatter.status))
                }

                // Source/URL (for gleanings)
                if (result.frontmatter.source) {
                    metaSection.appendChild(createInspectorRow('Source', result.frontmatter.source))
                }
                if (result.frontmatter.url) {
                    const row = document.createElement('div')
                    row.className = 'inspector-row'
                    const label = document.createElement('div')
                    label.className = 'inspector-label'
                    label.textContent = 'URL'
                    const value = document.createElement('a')
                    value.href = result.frontmatter.url
                    value.target = '_blank'
                    value.className = 'inspector-value'
                    value.style.color = '#6a8aaa'
                    value.style.textDecoration = 'none'
                    value.textContent = truncateUrl(result.frontmatter.url)
                    row.appendChild(label)
                    row.appendChild(value)
                    metaSection.appendChild(row)
                }

                container.appendChild(metaSection)
            }

            // Tags section
            if (result.tags && result.tags.length > 0) {
                const tagsSection = document.createElement('div')
                tagsSection.className = 'inspector-section'

                const tagsTitle = document.createElement('h3')
                tagsTitle.textContent = `Tags (${result.tags.length})`
                tagsSection.appendChild(tagsTitle)

                const tagsContainer = document.createElement('div')
                tagsContainer.className = 'inspector-tags'
                result.tags.forEach(tag => {
                    const tagSpan = document.createElement('span')
                    tagSpan.className = 'inspector-tag'
                    tagSpan.textContent = `#${tag}`
                    tagsContainer.appendChild(tagSpan)
                })
                tagsSection.appendChild(tagsContainer)

                container.appendChild(tagsSection)
            }

            // Description section
            if (result.description) {
                const descSection = document.createElement('div')
                descSection.className = 'inspector-section'

                const descTitle = document.createElement('h3')
                descTitle.textContent = 'Description'
                descSection.appendChild(descTitle)

                const descText = document.createElement('div')
                descText.style.fontSize = '12px'
                descText.style.color = '#b0b0b0'
                descText.style.lineHeight = '1.5'
                descText.textContent = result.description
                descSection.appendChild(descText)

                container.appendChild(descSection)
            }

            inspectorContent.replaceChildren(container)
        }

        function createScoreBar(label, displayValue, normalizedValue) {
            const row = document.createElement('div')
            row.className = 'inspector-row'
            row.style.borderBottom = 'none'
            row.style.marginBottom = '6px'

            const labelDiv = document.createElement('div')
            labelDiv.className = 'inspector-label'
            labelDiv.textContent = label

            const barContainer = document.createElement('div')
            barContainer.className = 'score-bar'
            barContainer.style.flex = '1'

            const valueDiv = document.createElement('div')
            valueDiv.className = 'score-value'
            valueDiv.textContent = typeof displayValue === 'number' ? displayValue.toFixed(3) : displayValue

            const visualDiv = document.createElement('div')
            visualDiv.className = 'score-visual'

            const fillDiv = document.createElement('div')
            fillDiv.className = 'score-fill'
            fillDiv.style.width = `${Math.max(0, Math.min(100, normalizedValue * 100))}%`

            visualDiv.appendChild(fillDiv)
            barContainer.appendChild(valueDiv)
            barContainer.appendChild(visualDiv)

            row.appendChild(labelDiv)
            row.appendChild(barContainer)

            return row
        }

        function createInspectorRow(label, value) {
            const row = document.createElement('div')
            row.className = 'inspector-row'

            const labelDiv = document.createElement('div')
            labelDiv.className = 'inspector-label'
            labelDiv.textContent = label

            const valueDiv = document.createElement('div')
            valueDiv.className = 'inspector-value mono'
            valueDiv.textContent = value

            row.appendChild(labelDiv)
            row.appendChild(valueDiv)

            return row
        }

        function truncateUrl(url, maxLen = 40) {
            if (!url || url.length <= maxLen) return url
            return url.substring(0, maxLen - 3) + '...'
        }

        function formatDate(dateStr) {
            if (!dateStr) return null
            try {
                const date = new Date(dateStr)
                const year = date.getFullYear()
                const month = String(date.getMonth() + 1).padStart(2, '0')
                const day = String(date.getDate()).padStart(2, '0')
                return `${year}-${month}-${day}`
            } catch {
                return dateStr
            }
        }

        function showError(message) {
            // Simple error display (could enhance later)
            console.error(message)
        }

        function hideError() {
            // Stub for now
        }

        // Start the app
        initialize()
    </script>
</body>
</html>
